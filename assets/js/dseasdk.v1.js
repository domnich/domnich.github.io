const _version_str="1.0",EPOSVID=5013,ABLID="Sennheiser_UI_20_BL_USB",ABLCOOKIE="dsea.abl",HEADSETCOOKIE="dsea.headset";function setCookie(b,c,d=365){let a=new Date;a.setTime(a.getTime()+864e5*d);let e="expires="+a.toUTCString();document.cookie=b+"="+c+";"+e+";path=/;SameSite=None; Secure"}function getCookie(e){let c=e+"=",d=decodeURIComponent(document.cookie).split(";");for(let b=0;b<d.length;b++){let a=d[b];for(;" "==a.charAt(0);)a=a.substring(1);if(0==a.indexOf(c))return a.substring(c.length,a.length)}return""}function sendEvent(a,b){let c=new CustomEvent(a,{detail:b});document.dispatchEvent(c)}function postEvent(a,b){let c=new CustomEvent(a,{detail:b});setTimeout(function(){document.dispatchEvent(c)},0)}function dec2hexStringSimple(a){return(a+65536).toString(16).substr(-2).toUpperCase()}function dec2hexString(a){return"0x"+dec2hexStringSimple(a)}function getDeviceID(a){return getDeviceName(a).replaceAll(" ","_")}function getDeviceName(a){return a.productName}function dseaHSsetting(){this.getDefaultHeadset=function(){let b={},a={};return""===(raw=getCookie("dsea.headset"))||((a=JSON.parse(raw)).hasOwnProperty("default")&&(b.default=a.default),a.hasOwnProperty("serial")&&(b.serial=a.serial)),b}}function dseaABLsetting(){this.getABLRingtone=function(){return""===(ablraw=getCookie(ABLCOOKIE))?1:(ablr=JSON.parse(ablraw)).hasOwnProperty("ringtone")?3:1},this.getABLSound=function(){return""===(ablraw=getCookie(ABLCOOKIE))?"/common/sounds/BellPlay.wav":(abls=JSON.parse(ablraw)).hasOwnProperty("ringtone")?abls.ringtone:"/common/sounds/BellPlay.wav"},this.getABLVolume=function(){if(""===(ablraw=getCookie(ABLCOOKIE)))return 3;if((ablr=JSON.parse(ablraw)).hasOwnProperty("configuration")){let b=ablr.configuration;if(b.hasOwnProperty("volume")){let a=b.volume;if("Ringing_Volume_Off_ABL"===a)return -1;if("Ringing_Volume_Very_Low_ABL"===a)return 0;if("Ringing_Volume_Low_ABL"===a)return 2;if("Ringing_Volume_Medium_ABL"===a)return 3;if("Ringing_Volume_High_ABL"===a)return 5}}return ablr.hasOwnProperty("volume")?parseInt(ablr.volume):3},this.getABLPattern=function(){if(""===(ablraw=getCookie(ABLCOOKIE)))return 1;if((ablr=JSON.parse(ablraw)).hasOwnProperty("configuration")){let a=ablr.configuration;if(a.hasOwnProperty("pattern")){let b=a.pattern;if("Ringing_Pattern_Play_Once_ABL"===b)return 1;if("Ringing_Pattern_Play_On_Repeat_ABL"===b)return 2}}return ablr.hasOwnProperty("pattern")?parseInt(ablr.pattern):1},this.getPresenceList=function(){let b=getCookie(ABLCOOKIE);if(""!==b){let c=JSON.parse(b);if(c.hasOwnProperty("presences")){for(let e in presences=c.presences,r=[],presences)r.push(e);return r}}let a={};a.Available={ledcolor:"#00FF00",ledpattern:1},a.Away={ledcolor:"#FFFF00",ledpattern:1},a.Busy={ledcolor:"#FF0000",ledpattern:1},a.DoNotDisturb={ledcolor:"#0000FF",ledpattern:1},a.Offline={ledcolor:"#000000",ledpattern:0};let d={};return d.presences=a,setCookie(ABLCOOKIE,JSON.stringify(d)),["Available","Busy","Away","DoNotDisturb","Offline"]},this.getPresenceColor=function(a){let b=getCookie(ABLCOOKIE);if(""!==b){let c=JSON.parse(b);if(c.hasOwnProperty("presences")){let d=c.presences;if(d.hasOwnProperty(a))return d[a].ledcolor}}return"Available"==a?"#00FF00":"Away"==a?"#FFFF00":""==a?"#00FF00":"#FF0000"},this.getABLInACallColor=function(){let b=getCookie(ABLCOOKIE);if(""!==b){let a=JSON.parse(b);if(a.hasOwnProperty("configuration")){let c=a.configuration;if(c.hasOwnProperty("In_a_Call_ABL"))return FindColor(c.In_a_Call_ABL)}if(a.hasOwnProperty("inacall")){let d=a.inacall;if(d.hasOwnProperty("ledcolor"))return d.ledcolor}}return"#FF0000"},this.getABLOutgoingColor=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))){if((ablr=JSON.parse(ablraw)).hasOwnProperty("configuration")){let a=ablr.configuration;if(a.hasOwnProperty("Outgoing_call_ABL"))return FindColor(a.Outgoing_call_ABL)}if(ablr.hasOwnProperty("outgoingcall")){let b=ablr.outgoingcall;if(b.hasOwnProperty("ledcolor"))return b.ledcolor}}return"#FF0000"},this.getABLIncomingColor=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))){if((ablr=JSON.parse(ablraw)).hasOwnProperty("configuration")){let a=ablr.configuration;if(a.hasOwnProperty("Incoming_Call_ABL"))return FindColor(a.Incoming_Call_ABL)}if(ablr.hasOwnProperty("incomingcall")){let b=ablr.incomingcall;if(b.hasOwnProperty("ledcolor"))return b.ledcolor}}return"#FF0000"},this.getABLPresentingColor=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))&&(ablr=JSON.parse(ablraw)).hasOwnProperty("presenting")){let a=ablr.presenting;if(a.hasOwnProperty("ledcolor"))return a.ledcolor}return"#FF00FF"},this.getABLIMNotificationColor=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))&&(ablr=JSON.parse(ablraw)).hasOwnProperty("imnotification")){let a=ablr.imnotification;if(a.hasOwnProperty("ledcolor"))return a.ledcolor}return"#0000FF"},this.getABLInACallPattern=function(){let a=getCookie(ABLCOOKIE);if(""!==a){let b=JSON.parse(a);if(b.hasOwnProperty("inacall")){let c=b.inacall;if(c.hasOwnProperty("ledpattern"))return c.ledpattern}}return 1},this.getABLOutgoingPattern=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))&&(ablr=JSON.parse(ablraw)).hasOwnProperty("outgoingcall")){let a=ablr.outgoingcall;if(a.hasOwnProperty("ledpattern"))return a.ledpattern}return 2},this.getABLIncomingPattern=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))&&(ablr=JSON.parse(ablraw)).hasOwnProperty("incomingcall")){let a=ablr.incomingcall;if(a.hasOwnProperty("ledpattern"))return a.ledpattern}return 2},this.getABLPresentingPattern=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))&&(ablr=JSON.parse(ablraw)).hasOwnProperty("presenting")){let a=ablr.presenting;if(a.hasOwnProperty("ledpattern"))return a.ledpattern}return 1},this.getABLIMNotificationPattern=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))&&(ablr=JSON.parse(ablraw)).hasOwnProperty("imnotification")){let a=ablr.imnotification;if(a.hasOwnProperty("ledpattern"))return a.ledpattern}return 2},this.getPresencePattern=function(a){let c=getCookie(ABLCOOKIE);if(""!==c){let d=JSON.parse(c);if(d.hasOwnProperty("presences")){let b=d.presences;if(b.hasOwnProperty(a)&&b[a].hasOwnProperty("ledpattern"))return b[a].ledpattern}}return 1}}function dseacallcontrolsdk(e="",f="",g="",c=0){let b,i,j,k,h=null,a=this;a.brand=e,a.name=f,a.version=g,a.forceHID=c;let d=new log("DarkSeaGreen","LightSeaGreen");d.message("dseacallcontrollibrary initialized");let l=!1,m=!1,n=!1,o=!1;c>0?(d.message("Forcing webHID"),navigator.hid&&(h=new webhid(a.brand,a.name,a.version,!0),postEvent("LoginStatusChanged","EstablishConnection"))):((b=new WebSocket("wss://127.0.0.1:41088")).onopen=function(){d.message("Socket Opened"),l=!0},b.onmessage=function(b){if(!l)return;let a=JSON.parse(b.data);"Acknowledgement"===a.EventType?p(a):"Notification"===a.EventType?q(a):d.error("Unhandled Acknowledgement received "+b.data)},b.onclose=function(){d.message("Socket Closed"),l=!1,navigator.hid&&a.forceHID>=0&&(h=new webhid(a.brand,a.name,a.version),postEvent("LoginStatusChanged","EstablishConnection"))});var p=function(a){if(i=a.Event,j=a.CallID,0!==parseInt(a.ReturnCode)){d.error("ErrorCode "+i+" ("+a.ReturnCode+")");return}if("EstablishConnection"===i){d.message("acknowledgement EstablishConnection","DarkSeaGreen"),postEvent("LoginStatusChanged","EstablishConnection"),m=!0,t();return}if("TerminateConnection"===i){d.message("acknowledgement TerminateConnection","DarkSeaGreen"),postEvent("LoginStatusChanged","TerminateConnection"),m=!1;return}if(m){if("SystemInformation"===i){d.message("acknowledgement SystemInformation: "+a.ProductName+" version: "+a.ProductVersion,"DarkSeaGreen"),postEvent("SystemInformation",a.ProductName+" v. "+a.ProductVersion);return}if("SPLoggedIn"===i){d.message("acknowledgement SPLoggedIn","DarkSeaGreen"),postEvent("LoginStatusChanged","SPLoggedIn"),postEvent("BLsPresent",-1),n=!0;return}if("SPLoggedOut"===i){d.message("acknowledgement SPLoggedOut","DarkSeaGreen"),postEvent("LoginStatusChanged","SPLoggedOut"),postEvent("BLsPresent",0),n=!1;return}n&&(void 0===j?d.message("acknowledgement:"+i,"DarkSeaGreen"):(d.message("acknowledgement:"+i+" callid:"+j,"DarkSeaGreen"),"IncomingCall"===i&&sendEvent("IncomingCall",j),"InCallAccepted"==i&&sendEvent("InCallAccepted",j)))}},q=function(b){(i=b.Event,j=b.CallID,"SocketConnected"===i)?(d.message("notification SocketConnected","YellowGreen"),postEvent("LoginStatusChanged","SocketConnected"),s()):"HeadsetConnected"===i?(d.message("notification HeadsetConnected","YellowGreen"),postEvent("HeadsetConnected",b.HeadsetName)):"HeadsetDisconnected"===i?(d.message("notification HeadsetDisconnected","YellowGreen"),postEvent("HeadsetDisconnected",b.HeadsetName)):"MuteSoftphone"===i?(d.message("notification MuteSoftphone","YellowGreen"),postEvent("MuteMicrophone",!0)):"UnmuteSoftphone"===i?(d.message("notification UnmuteSoftphone","YellowGreen"),postEvent("MuteMicrophone",!1)):"InCallAccepted"===i?(d.message("notification InCallAccepted "+j,"YellowGreen"),postEvent("AcceptCall",j)):"InCallRejected"===i?(d.message("notification InCallRejected","YellowGreen"),postEvent("RejectCall",j)):"CallEnded"===i?(d.message("notification CallEnded","YellowGreen"),postEvent("EndCall",j)):"CallHold"===i?(d.message("notification CallHold","YellowGreen"),postEvent("HoldCall",j)):"HeldCallResumed"===i?(d.message("notification HeldCallResumed","YellowGreen"),postEvent("ResumeCall",j)):"ListenerClosed"===i?(d.message("ListenerClosed received","YellowGreen"),a.SendTerminateEvent()):"BLsPresent"===i?(d.message("notification BLsPresent","YellowGreen"),postEvent("BLsPresent",b.ablDevices)):"HeadsetAvailable"===i?(d.message("notification HeadsetAvailable","YellowGreen"),postEvent("HeadsetAvailable",{name:b.HeadsetName,id:b.HeadsetPath,serial:"",firmware:"",vid:"",pid:""})):"HeadsetRemoved"===i?(d.message("notification HeadsetRemoved","YellowGreen"),postEvent("HeadsetRemoved",{name:b.HeadsetName,id:b.HeadsetPath,serial:"",firmware:"",vid:"",pid:""})):"Redial"===i?(d.message("notification Redial","YellowGreen"),postEvent("Redial",0)):"Offhook"===i?(d.message("notification Offhook","YellowGreen"),postEvent("Offhook",0)):"InCallAcceptedOnOffhook"===i?(d.message("notification InCallAcceptedOnOffhook","YellowGreen"),postEvent("InCallAcceptedOnOffhook",b)):void 0==j?d.message("notification:"+i,"YellowGreen"):d.message("notification:"+i+" callid:"+j,"YellowGreen")},r=function(a){l&&b.send(JSON.stringify(a))},s=function(){d.message("sending EstablishConnection"),(k={Event:"EstablishConnection",EventType:"Request",SPIconImage:"SPImage.ico",AudioDeviceChangesSupport:"Yes",DNDOption:"Yes",MuteSupport:"Yes",RedialSupport:"Yes",OffHookSupport:"Yes"}).SPName="Softphone::"+a.name,r(k)},t=function(){if(!l&&null!==h){postEvent("SystemInformation","DSEA Call Control JS Library v. 1.0");return}d.message("sending SystemInformation"),r({Event:"SystemInformation",EventType:"Request"})};this.SendLoginEvent=function(){if(!l&&null!==h){h.open(),postEvent("LoginStatusChanged","SPLoggedInHID"),t();return}m&&(d.message("sending SPLoggedIn"),r({Event:"SPLoggedIn",EventType:"Request"}))},this.SendLogoutEvent=function(){if(!l&&null!==h){h.close(),postEvent("LoginStatusChanged","SPLoggedOutHID");return}n&&(d.message("sending SPLoggedOut"),r({Event:"SPLoggedOut",EventType:"Request"}))},this.SendTerminateEvent=function(){if(!l&&null!==h){h.close(),sendEvent("LoginStatusChanged","TerminateConnection");return}n&&this.SendLogoutEvent(),m&&(d.message("sending TerminateConnection"),r({Event:"TerminateConnection",EventType:"Request"}))},this.SendMuteStatus=function(a){if(!l&&null!==h){h.mute(a);return}n&&((o=a)?(d.message("sending MuteHeadset"),r({Event:"MuteHeadset",EventType:"Request"})):(d.message("sending UnmuteHeadset"),r({Event:"UnmuteHeadset",EventType:"Request"})))},this.SendIncomingCallEvent=function(a){if(!l&&null!==h){h.incoming(a);return}n&&(d.message("sending IncomingCall "+a),r({Event:"IncomingCall",EventType:"Request",CallID:a}))},this.SendOutgoingCallEvent=function(a){if(!l&&null!==h){h.outgoing(a);return}n&&(d.message("sending OutgoingCall "+a),r({Event:"OutgoingCall",EventType:"Request",CallID:a}))},this.SendEndCallEvent=function(a){if(!l&&null!==h){h.end(a);return}n&&(d.message("sending CallEnded "+a),r({Event:"CallEnded",EventType:"Request",CallID:a}))},this.SendHoldCallEvent=function(a){if(!l&&null!==h){h.hold(a);return}n&&(d.message("sending CallHold "+a),r({Event:"CallHold",EventType:"Request",CallID:a}))},this.SendActiveCallEvent=function(a){if(!l&&null!==h){h.active(a);return}n&&(d.message("sending InCallAccepted"),r({Event:"InCallAccepted",EventType:"Request",CallID:a}))},this.getBLPresenceList=function(){return l||null===h?m?["Available","Busy","Away","DoNotDisturb","Offline"]:[]:myABLsetting.getPresenceList()},this.SendPresenceEvent=function(a){if(!l&&null!==h){h.setBLPresence(a);return}n&&(d.message("sending SendPresenceEvent "+a),r({Event:"SetPresence",EventType:"Request",State:a}))},this.SendPresentingEvent=function(a){if(!l&&null!==h){h.setPresenting(a);return}n&&(d.message("sending SendPresentingEvent "+a),r({Event:"SetPresenting",EventType:"Request",State:a}))},this.SendIMEvent=function(){if(!l&&null!==h){h.setIMEvent();return}n&&(d.message("sending SetIMEvent"),r({Event:"SetIMEvent",EventType:"Request"}))},this.SendActiveDeviceChanged=function(f,c){var a;if(!l&&null!==h){h.headset(c);return}if(!n)return;let b=1;f||(b=0);let e=((a=c).charCodeAt(0)>47&&58>a.charCodeAt(0)&&"-"===a[1]&&" "===a[2]&&(a=a.substring(3)),a.toLowerCase());d.message("sending ActiveDeviceChanged "+e+" "+b),r({Event:"ActiveDeviceChanged",EventType:"Request",HSSTATUS:b,HeadsetPath:e})},this.AllowHS=function(){if(!l&&null!==h){h.select();return}},this.AllowBL=function(){if(!l&&null!==h){h.selectBL();return}}}function log(b,c){let a=this;a.active=!0,a.color1=b,a.color2=c;let d="padding: 3px;height: 18px; line-height: 18px;font-size: 12px;",e="border:1px solid black;",f="border-top:1px solid black;border-left:1px solid black;border-right:1px solid black;";this.activate=function(b=!0){a.active=b},this.image=function(c,d=100){if(a.active){var b=new Image;b.onload=function(){var b=["font-size: 1px;","border: 1px solid black;","padding: "+d+"px "+d+"px;","background: "+a.color2+" url("+c+") no-repeat;","background-size: contain;"].join(" ");console.log("%c ",b)},b.src=c}},this.led=function(c,f,g,h){if(a.active){for(;c.length<75;)c+=" ";var b=[];b.push("%c   %c %c"+c),b.push(d+"border: 1px solid black;border-radius: 50%;background: rgb("+f+","+g+","+h+")"),b.push(d),b.push(d+e+"background:"+a.color2+";"),console.log.apply(this,b)}},this.error=function(a){this.message(a,"Crimson")},this.connection=function(a){this.message(a,"DarkKhaki")},this.init=function(a){this.message(a,"Khaki")},this.message=function(b,c=""){if(a.active)for(""===c&&(c=a.color2);b.length<81;)(b=" "+b).length<81&&(b+=" ")},this.report=function(b,j,k,i="",h=""){if(a.active){""===i&&(i=a.color1),""===h&&(h=a.color2);for(var g="%c"+j+" ("+k+")";g.length<40;)g+=" ";for(i=0;i<b.length;i++){for(g+="%c\n",item="%c "+i+" "+b[i][0];item.length<40-b[i][1].toString().length-2;)item+=" ";item+=" "+b[i][1]+" ",g+=item}margin="","INPUT"===j.toUpperCase().substr(0,5)&&(margin="margin-left: 283px;");var c=[];for(c.push(g),c.push(d+f+margin+"background:"+i+";"),j=0;j<b.length;j++)c.push(""),j===b.length-1?c.push(d+e+margin+"background:"+h+";"):c.push(d+f+margin+"background:"+h+";");console.log.apply(this,c)}},this.jsonreport=function(j,c){if(a.active){for(var g="%c"+j;g.length<83;)g+=" ";for(var b in cnt=0,c)if(Array.isArray(c[b])){if("configSettings"===b)for(var i in c[b]){for(g+="%c\n",line=c[b][i].FeatureName;line.length<39;)line=" "+line;for(line=" "+line,line+=" : ",y=0,str=c[b][i].FeatureValue;line.length<80;)y>=str.length?line+=" ":line+=str[y++];line+=" ",g+="%c"+line,cnt++}}else{for(g+="%c\n",line=b;line.length<39;)line=" "+line;for(line=" "+line,line+=" : ",y=0,str="",null!==c[b]&&(str=c[b].toString());line.length<80;)y>=str.length?line+=" ":line+=str[y++];line+=" ",g+="%c"+line,cnt++}var h=[];for(h.push(g),h.push(d+f+"background:"+a.color1+";"),j=0;j<cnt;j++)h.push(""),j===cnt-1?h.push(d+e+"background:"+a.color2+";"):h.push(d+f+"background:"+a.color2+";");console.log.apply(this,h)}}}function abl(a){let b=this;b.callback=a;let d=[],c=null;function e(a){if(len=parseInt((inputReportBuffer=new Uint8Array(a.data.buffer))[0]),cmd=parseInt(inputReportBuffer[1]),1===cmd&&8&inputReportBuffer[27])for(i=0;i<d.length;i++)d[i].device==a.device&&(d[i].ringtone=3)}this.color=async function(b,a){if(7===b.length&&"#"===b[0])for(time=256,4==a&&(a=2,time=1024),r=(16711680&(colordec=parseInt(b.replace("#","0x"))))>>16,g=(65280&colordec)>>8,b=(255&colordec)>>0,buffer=new Uint8Array(63),buffer.fill(0),x=0,buffer[x++]=18,buffer[x++]=2,buffer[x++]=r,buffer[x++]=g,buffer[x++]=b,buffer[x++]=r,buffer[x++]=g,buffer[x++]=b,buffer[x++]=a,buffer[x++]=255,buffer[x++]=255,buffer[x++]=255,buffer[x++]=255,2===parseInt(a)?(buffer[x++]=(255&time)>>0,buffer[x++]=(65280&time)>>8,buffer[x++]=(255&time)>>0,buffer[x++]=(65280&time)>>8):3===parseInt(a)&&(buffer[x++]=255,buffer[x++]=255,buffer[x++]=255,buffer[x++]=255),i=0;i<d.length;i++)d[i].device.opened&&d[i].device.sendReport(1,buffer).catch(function(a){c.error("Error in SendReport abl::color "+a)})},this.select=async function(){if(!navigator.hid){alert("navigator.hid not defined - Use Chrome 89+ or install EPOS Connect");return}if(0!==(device=await navigator.hid.requestDevice({filters:filters=[{vendorId:5013,productId:116}]})).length){for(i=0,dev=device[0],found=!1;i<d.length;i++)dev===d[i].device&&(found=!0);found||(c.message("Adding device "+dev.productName),addDevice(dev))}},this.play=function(b,e,a){for((buffer=new Uint8Array(63)).fill(0),x=0,buffer[x++]=9,buffer[x++]=4,buffer[x++]=b,buffer[x++]=e,buffer[x++]=(255&a)>>0,buffer[x++]=(65280&a)>>8,buffer[x++]=(16711680&a)>>16,buffer[x++]=(4278190080&a)>>24,i=0;i<d.length;i++)d[i].device.opened&&(buffer[2]=d[i].ringtone,d[i].device.sendReport(1,buffer).catch(function(a){c.error("Error in SendReport abl::play "+a)}))},this.open=async function(){await init(),b.callback("loaded")},this.close=async function(){for(b.color("#000000",0),b.play(0,0,0),i=d.length-1;i>=0;i--)d[i].device.opened&&(c.message("Device removed "+d[i].device.productName),d[i].device.close(),d.splice(i,1));d=[],b.callback("devices",0)},navigator.hid&&(navigator.hid.addEventListener("connect",async({device:a})=>{116===a.productId&&(c.connection(`HID connected: ${a.productName}`),addDevice(a))}),navigator.hid.addEventListener("disconnect",({device:a})=>{if(116===a.productId){for(c.connection(`HID disconnected: ${a.productName}`),i=0;i<d.length;i++)if(d[i].device===a){c.message("Device removed "+a.productName),d[i].device.close(),d.splice(i,1),b.callback("devices",d.length);return}}})),addDevice=async function(a){116===a.productId&&a.open().then(function(){if(a.opened){var f;let c={};c.device=a,c.serial="",c.firmware="",c.wait=0,c.number=d.length,c.vid=parseInt(5013),c.pid=parseInt(116),c.id=getDeviceID(a),c.ringtone=0,d.push(c),b.callback("devices",d.length),b.color("#000000",0),a.oninputreport=e,f=a,(buffer=new Uint8Array(63)).fill(0),x=0,buffer[x++]=3,buffer[x++]=1,f.sendReport(1,buffer).catch(function(a){console.log("Error in status "+a)})}})},init=async function(){if(navigator.hid){let a=await navigator.hid.getDevices(),b=await a.map(async a=>{let b=await addDevice(a);return b});await Promise.all(b)}},c=new log("PaleVioletRed","LightPink")}function webhid(b="",c="",d=""){let a=this;a.name=c,a.brand=b,a.version=d,myABLsetting=new dseaABLsetting,myHSsetting=new dseaHSsetting;let e=null,f=null,h="",i=!1,j=!0,k=[],l=!0,m=!1,n=new Map;async function o(){defaultHeadset=myHSsetting.getDefaultHeadset();for(let a=1;a<k.length;a++)if(k[a].id===defaultHeadset.default){k.splice(0,0,k.splice(a,1)[0]),e.message("New device selected "+k[0].name),postEvent("HeadsetConnected",k[0].name);break}r()}async function p(){f.open(),await q(),setTimeout(o,2e3)}async function q(){if(!navigator.hid)return;let a=await navigator.hid.getDevices(),b=await a.map(async a=>{let b=await addNewHeadset(a);return b});await Promise.all(b)}async function r(){if(0===k.length){e.message("No headset connected");return}l&&(e.message("Device in use by SDK is: "+k[0].name),postEvent("HeadsetConnected",k[0].name)),t()}async function s(){let a=null;for(x=0;x<k[0].device.collections.length;x++)65535===k[0].device.collections[x].usagePage&&(a=k[0].device.collections[x]);if(null===a)for(x=0;x<k[0].device.collections.length;x++)65368===k[0].device.collections[x].usagePage&&(a=k[0].device.collections[x]);if(null===a)for(x=0;x<k[0].device.collections.length;x++)11===k[0].device.collections[x].usagePage&&(a=k[0].device.collections[x]);if(null===a){e.error("Device does not have Telephony Collection, using defaults");return}let b=[];for(q=0;q<a.outputReports.length;q++)for(x=0,reportPos=0;x<a.outputReports[q].items.length;x++)for(y=0;y<a.outputReports[q].items[x].usages.length;y++){if(usagePage=(16711680&a.outputReports[q].items[x].usages[y])>>16,usage=255&a.outputReports[q].items[x].usages[y],149===usagePage||8===usagePage)switch(k[0].outputReportID=a.outputReports[q].reportId,usage){case 9:k[0].led_mute=1<<reportPos,b.push(["led-mute",dec2hexString(usage)]);break;case 23:k[0].led_offhook=1<<reportPos,b.push(["led-offhook",dec2hexString(usage)]);break;case 158:k[0].led_ringer=1<<reportPos,b.push(["led-ringer",dec2hexString(usage)]);break;case 24:k[0].led_ring=1<<reportPos,b.push(["led-ring",dec2hexString(usage)]);break;case 32:k[0].led_hold=1<<reportPos,b.push(["led-hold",dec2hexString(usage)]);break;case 33:k[0].led_microphone=1<<reportPos,b.push(["led-microphone",dec2hexString(usage)]);break;case 42:k[0].led_online=1<<reportPos,b.push(["led-online",dec2hexString(usage)])}else 19===usagePage&&158===usage&&(k[0].led_ringer=1<<reportPos,b.push([dec2hexString(usagePage),dec2hexString(usage)]));reportPos+=a.outputReports[q].items[x].reportSize}e.report(b,"Output "+k[0].name,k[0].outputReportID);let c=[];for(q=0;q<a.inputReports.length;q++)for(x=0,reportPos=0;x<a.inputReports[q].items.length;x++)for(y=0;y<a.inputReports[q].items[x].usages.length;y++){if(usagePage=(16711680&a.inputReports[q].items[x].usages[y])>>16,usage=255&a.inputReports[q].items[x].usages[y],19===usagePage||11===usagePage)switch(k[0].inputReportID=a.inputReports[q].reportId,usage){case 32:k[0].telephony_hook=1<<reportPos,c.push(["telephony-hook",dec2hexString(usage)]);break;case 33:k[0].telephony_flash=1<<reportPos,c.push(["telephony-flash",dec2hexString(usage)]);break;case 36:k[0].telephony_redial=1<<reportPos,c.push(["telephony-redial",dec2hexString(usage)]);break;case 47:k[0].telephony_mute=1<<reportPos,c.push(["telephony-mute",dec2hexString(usage)]);break;case 38:k[0].telephony_drop=1<<reportPos,c.push(["telephony-drop",dec2hexString(usage)])}reportPos+=a.inputReports[q].items[x].reportSize}e.report(c,"Input "+k[0].name,k[0].inputReportID)}function t(d=-1){let a=d;if(-1==a&&(a=B()),byte=0,1===a?(f.color(myABLsetting.getABLIncomingColor(),myABLsetting.getABLIncomingPattern()),0!==k.length&&(byte|=k[0].led_ring|k[0].led_ringer)):8===a?(i?f.color(myABLsetting.getABLPresentingColor(),myABLsetting.getABLPresentingPattern()):f.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==k.length&&(byte|=k[0].led_offhook)):10===a?(i?f.color(myABLsetting.getABLPresentingColor(),myABLsetting.getABLPresentingPattern()):f.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==k.length&&(byte|=k[0].led_offhook|k[0].led_hold)):9===a?(i?f.color(myABLsetting.getABLPresentingColor(),myABLsetting.getABLPresentingPattern()):f.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==k.length&&(byte|=k[0].led_offhook|k[0].led_ring|k[0].led_ringer)):11===a?(i?f.color(myABLsetting.getABLPresentingColor(),myABLsetting.getABLPresentingPattern()):f.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==k.length&&(byte|=k[0].led_offhook|k[0].led_ring|k[0].led_hold|k[0].led_ringer)):4===a?(f.color(myABLsetting.getABLOutgoingColor(),myABLsetting.getABLOutgoingPattern()),0!==k.length&&(byte|=k[0].led_offhook)):6===a?(f.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==k.length&&(byte|=k[0].led_offhook|k[0].led_hold)):5===a?(f.color(myABLsetting.getABLOutgoingColor(),myABLsetting.getABLOutgoingPattern()),0!==k.length&&(byte|=k[0].led_offhook|k[0].led_ring|k[0].led_ringer)):7===a?(f.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==k.length&&(byte|=k[0].led_offhook|k[0].led_ring|k[0].led_hold|k[0].led_ringer)):2===a?(f.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==k.length&&(byte|=k[0].led_hold)):3===a?(f.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==k.length&&(byte|=k[0].led_ring|k[0].led_hold|k[0].led_ringer)):""!=h?f.color(myABLsetting.getPresenceColor(h),myABLsetting.getPresencePattern(h)):f.color(myABLsetting.getPresenceColor("Available"),myABLsetting.getPresencePattern("Available")),m&&0!==k.length&&(byte|=k[0].led_mute|k[0].led_microphone),0!==k.length&&5013===k[0].device.vendorId&&(byte|=128),0!==k.length&&k[0].outputReportID>0&&l&&(function(c,b){let a=[["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0]];for(i=0;i<8;i++)k[0].led_offhook===1<<i&&(a[i][0]="Offhook",(b&k[0].led_offhook)>0&&(a[i][1]=1)),k[0].led_microphone===1<<i&&(a[i][0]="Microphone",(b&k[0].led_microphone)>0&&(a[i][1]=1)),k[0].led_ring===1<<i&&(a[i][0]="Ring",(b&k[0].led_ring)>0&&(a[i][1]=1)),k[0].led_ringer===1<<i&&(a[i][0]="Ringer",(b&k[0].led_ringer)>0&&(a[i][1]=1)),k[0].led_mute===1<<i&&(a[i][0]="Mute",(b&k[0].led_mute)>0&&(a[i][1]=1)),k[0].led_online===1<<i&&(a[i][0]="Online",(b&k[0].led_online)>0&&(a[i][1]=1)),k[0].led_hold===1<<i&&(a[i][0]="Hold",(b&k[0].led_hold)>0&&(a[i][1]=1)),128==1<<i&&5013===k[0].device.vendorId&&(a[i][0]="Vendor Page",(128&b)>0&&(a[i][1]=1));e.report(a,"Output Report "+k[0].outputReportID,c)}(A(a),byte),k[0].lastOutputReportTime=Date.now(),k[0].lastOutputReport=byte,k[0].device.sendReport(k[0].outputReportID,new Uint8Array([byte])).catch(function(a){e.error("Error in SendReport webhid::updatehs "+a)})),1===a){if(j){j=!1;let c=myABLsetting.getABLPattern(),b=myABLsetting.getABLRingtone();-1===myABLsetting.getABLVolume()?f.play(b,0,0):1===c?f.play(b,3,1):2===c&&f.play(b,1,0)}}else j=!0,f.play(0,0,0)}function u(){for(let a of n.keys())"active"===n.get(a).state&&postEvent("EndCall",a)}function v(){for(let a of n.keys())"outgoing"===n.get(a).state&&postEvent("RejectCall",a)}function w(){for(let a of n.keys())"active"===n.get(a).state&&postEvent("HoldCall",a)}function x(){for(let a of(oldest=Date.now(),id="",n.keys()))"incoming"===n.get(a).state&&n.get(a).created<oldest&&(oldest=n.get(a).created,id=a);""!==id&&postEvent("AcceptCall",id)}function y(){for(let a of(oldest=Date.now(),id="",n.keys()))"onhold"===n.get(a).state&&n.get(a).active<oldest&&(oldest=n.get(a).active,id=a);""!==id&&postEvent("ResumeCall",id)}function z(b){let c=b.reportId,d=b.data,a=d.getUint8(0);b.device===k[0].device&&(state=B(),c===k[0].inputReportID)&&((function(c,b){let a=[["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0]];for(i=0;i<8;i++)k[0].telephony_hook===1<<i&&(a[i][0]="Hook",(b&k[0].telephony_hook)>0&&(a[i][1]=1)),k[0].telephony_flash===1<<i&&(a[i][0]="Flash",(b&k[0].telephony_flash)>0&&(a[i][1]=1)),k[0].telephony_redial===1<<i&&(a[i][0]="Redial",(b&k[0].telephony_redial)>0&&(a[i][1]=1)),k[0].telephony_mute===1<<i&&(a[i][0]="Mute",(b&k[0].telephony_mute)>0&&(a[i][1]=1)),k[0].telephony_drop===1<<i&&(a[i][0]="Drop",(b&k[0].telephony_drop)>0&&(a[i][1]=1));e.report(a,"Input Report "+k[0].inputReportID,c)}(A(state),a),(k[0].lastInputReport&k[0].telephony_mute)>0)?(a&k[0].telephony_mute)==0?(e.message("MUTE"),postEvent("MuteMicrophone",m=!m)):e.error("ABORTED MUTE"):(k[0].lastInputReport&k[0].telephony_redial)>0?(a&k[0].telephony_redial)==0?(e.message("REDIAL"),postEvent("Redial",0)):e.error("ABORTED REDIAL"):(k[0].lastInputReport&k[0].telephony_flash)>0?(a&k[0].telephony_flash)==0?(e.message("FLASH"),4===state?v():5===state?(v(),setTimeout(function(){x()},200)):8===state?w():9===state?(w(),setTimeout(function(){x()},200)):2===state||3===state||10===state||6===state||11===state||7===state?y():e.message("IGNORED")):e.error("ABORTED FLASH"):(k[0].lastInputReport&k[0].telephony_drop)>0?(a&k[0].telephony_drop)==0?(e.message("DROP"),9===state||11===state||5===state||7===state||1===state||3===state?function(){for(let a of(oldest=Date.now(),id="",n.keys()))"incoming"===n.get(a).state&&n.get(a).created<oldest&&(oldest=n.get(a).created,id=a);""!==id&&postEvent("RejectCall",id)}():e.message("IGNORED")):e.error("ABORTED DROP"):Date.now()-k[0].lastOutputReportTime<1e3&&(0===a||a===k[0].telephony_hook)?e.message(0===a?"HOOK ON STATUS":"HOOK OFF STATUS"):(k[0].lastInputReport&k[0].telephony_hook)==0&&a===k[0].telephony_hook?(e.message("HOOK OFF"),0===state?(t(4),postEvent("Offhook",k[0].name),setTimeout(function(){t()},1e3)):2===state?y():1===state||3===state?x():e.message("IGNORED")):(k[0].lastInputReport&k[0].telephony_hook)>0&&0===a?(e.message("HOOK ON"),8===state?u():10===state?(u(),setTimeout(function(){y()},200)):9===state||11===state?(u(),setTimeout(function(){x()},200)):4===state?v():6===state?(v(),setTimeout(function(){y()},200)):5===state||7===state?(v(),setTimeout(function(){x()},200)):e.message("IGNORED")):(a&k[0].telephony_redial)>0?e.message("REDIAL PART 1"):(a&k[0].telephony_mute)>0?e.message("MUTE PART 1"):(a&k[0].telephony_flash)>0?e.message("FLASH PART 1"):(a&k[0].telephony_drop)>0&&e.message("DROP PART 1"),k[0].lastInputReport=a)}function A(a){switch(a){case 0:return"IDLE";case 1:return"INCOMING";case 2:return"HOLDING";case 3:return"INCOMING_HOLDING";case 4:return"OUTGOING";case 5:return"OUTGOING_INCOMING";case 6:return"OUTGOING_HOLDING";case 7:return"OUTGOING_INCOMING_HOLDING";case 8:return"ACTIVE";case 9:return"ACTIVE_INCOMING";case 10:return"ACTIVE_HOLDING";case 11:return"ACTIVE_INCOMING_HOLDING";default:return"UNKNOWN"}}function B(){let a=0,b=0,c=0,d=0;for(let e of n.keys())"incoming"==n.get(e).state&&a++,"outgoing"==n.get(e).state&&b++,"active"==n.get(e).state&&c++,"onhold"==n.get(e).state&&d++;if(a>0&&0===b&&0===c&&0===d)return 1;if(a>0&&0===b&&0===c&&d>0)return 3;if(0===a&&0===b&&1===c&&0===d)return 8;if(0===a&&0===b&&1===c&&d>0)return 10;if(a>0&&0===b&&1===c&&0===d)return 9;if(a>0&&0===b&&1===c&&d>0)return 11;if(0===a&&1===b&&0===c&&0===d)return 4;else if(0===a&&1===b&&0===c&&d>0)return 6;else if(a>0&&1===b&&0===c&&0===d)return 5;else if(a>0&&1===b&&0===c&&d>0)return 7;else if(0===a&&0===b&&0===c&&d>0)return 2;else if(0===a&&0===b&&0===c&&0===d)return 0;else return 12}async function g(a,b){"loaded"===a?e.init("abl.js was allocated in webhid.js"):"devices"===a?(e&&e.message(b+" ABL devices present"),postEvent("BLsPresent",b),t()):console.log(a+" : "+b)}this.incoming=function(a){if(n.has(String(a))){if("incoming"===n.get(String(a)).state)return}else n.set(String(a),{state:"none",created:Date.now(),active:0,type:"incoming",started:new Date});n.get(String(a)).state="incoming",t()},this.outgoing=function(c){if(n.has(String(c))){if("outgoing"===n.get(String(c)).state)return}else n.set(String(c),{state:"none",created:Date.now(),active:0,type:"outgoing",started:new Date});for(let b of n.keys())if(b!==String(c)){if("outgoing"===n.get(b).state){a.end(String(b)),postEvent("EndCall",b),setTimeout(function(){a.outgoing(c)},200);return}if("active"===n.get(b).state){a.hold(String(b)),postEvent("HoldCall",b),setTimeout(function(){a.outgoing(c)},200);return}}n.get(String(c)).state="outgoing",t()},this.active=function(c){if(n.has(String(c))){if("active"===n.get(String(c)).state)return}else n.set(String(c),{state:"none",created:Date.now(),active:0,type:"other",started:new Date});for(let b of n.keys())if(b!==String(c)){if("outgoing"===n.get(b).state){a.end(String(b)),postEvent("EndCall",b),setTimeout(function(){a.active(c)},200);return}if("active"===n.get(b).state){a.hold(String(b)),postEvent("HoldCall",b),setTimeout(function(){a.active(c)},200);return}}n.get(String(c)).state="active",n.get(String(c)).active=Date.now(),t()},this.hold=function(a){if(n.has(String(a))){if("onhold"===n.get(String(a)).state)return}else n.set(String(a),{state:"none",created:Date.now(),active:Date.now(),type:"other",started:new Date});n.get(String(a)).state="onhold",t()},this.end=function(a){n.has(String(a))&&(n.delete(String(a)),t())},this.open=async function(){p()},this.close=function(){(function a(){if(0!==k.length){for(l&&postEvent("HeadsetDisconnected",k[0].name),i=0;i<k.length;i++)k[i].device.sendReport(k[0].outputReportID,new Uint8Array([0])).catch(function(a){e.error("Error in SendReport webhid::closehslist "+a)}),k[i].device.close(),k[i].device.oninputreport=null;k=[]}})(),f.close()},this.mute=function(a){m=a,t()},this.select=async function(){if(!navigator.hid){alert("navigator.hid not defined - Use Chrome 89+ or install EPOS Connect");return}if(0!==(devices=await navigator.hid.requestDevice({filters:filters=[{usagePage:65535,vendorId:5013},{usagePage:65368,vendorId:5013},{usagePage:11}]})).length){for(i=0,dev=devices[0];i<k.length&&k[i].device!==dev;i++);if(l=!0,i===k.length)t(0),await addNewHeadset(dev);else{if(!(i>0))return;t(0),k.splice(0,0,k.splice(i,1)[0])}r()}},this.headset=async function(b){for(let a=0;a<k.length;a++)if(k[a].name===b){l=!0,0!==a&&(t(0),k.splice(0,0,k.splice(a,1)[0])),r(),e.message("New device selected "+k[0].name);return}t(0),e.message("Non Supported device selected "+b),k.length&&postEvent("HeadsetDisconnected",k[0].name),l=!1,postEvent("HeadsetConnected",b)},this.selectBL=function(){f.select()},this.setBLPresence=function(a){h=a,t()},this.setPresenting=function(a){i=a,t()},this.setIMEvent=function(){f.color(myABLsetting.getABLIMNotificationColor(),myABLsetting.getABLIMNotificationPattern()),setTimeout(function(){t()},5e3)},addNewHeadset=async function(b){var c;for(x=0,found=!1;x<b.collections.length;x++)(5013===b.vendorId&&(65535===b.collections[x].usagePage||65368===b.collections[x].usagePage)||11===b.collections[x].usagePage)&&(found=!0);if(!found||(await b.open(),!b.opened))return;b.oninputreport=z;let a={};a.device=b,a.serial="",a.firmware="",a.vid=parseInt(b.vendorId),a.pid=parseInt(b.productId),a.id=getDeviceID(b),a.name=getDeviceName(b),a.slave1id="",a.slave1name="",a.slave1firmware="",a.slave1serial="",a.slave2id="",a.slave2name="",a.slave2firmware="",a.slave2serial="",a.slave1pid=0,a.slave2pid=0,a.Commands=[],a.inputReportID=0,a.outputReportID=0,a.telephony_hook=0,a.telephony_flash=0,a.telephony_redial=0,a.telephony_mute=0,a.telephony_drop=0,a.led_ringer=0,a.led_offhook=0,a.led_microphone=0,a.led_ring=0,a.led_mute=0,a.led_online=0,a.led_hold=0,a.lastOutputReportTime=0,a.lastOutputReport=0,a.lastInputReport=0,k.unshift(a),s(),l&&(e.message("New device selected "+a.name),postEvent("HeadsetConnected",a.name)),c=a,e.message("New device available "+c.name),postEvent("HeadsetAvailable",{name:c.name,id:c.id,serial:c.serial,firmware:c.firmware,vid:c.vid,pid:c.pid})},navigator.hid&&(navigator.hid.addEventListener("connect",async({device:a})=>{setTimeout(async function(){for(let b=0;b<a.collections.length;b++)if(5013===a.vendorId&&(65535===a.collections[b].usagePage||65368===a.collections[b].usagePage)||11===a.collections[b].usagePage){e.connection("HID connected: "+getDeviceName(a)),await addNewHeadset(a),await r();break}},1e3)}),navigator.hid.addEventListener("disconnect",async({device:b})=>{for(let c=0;c<b.collections.length;c++)if(5013===b.vendorId&&(65535===b.collections[c].usagePage||65368===b.collections[c].usagePage)||11===b.collections[c].usagePage){for(let a=0;a<k.length;a++)if(k[a].device===b){e.connection("HID disconnected: "+k[a].name),postEvent("HeadsetRemoved",{name:k[a].name,id:k[a].id,serial:k[a].serial,slave1id:k[a].slave1id.replace("EPOS_",""),slave1serial:k[a].slave1serial,slave2id:k[a].slave2id.replace("EPOS_",""),slave2serial:k[a].slave2serial}),0==a&&l&&postEvent("HeadsetDisconnected",k[0].name),k[a].device.close(),k.splice(a,1),0===a&&l&&await r();return}}})),e=new log("LightSkyBlue","LightBlue"),f=new abl(g)}