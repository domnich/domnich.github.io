"use strict";(self.webpackChunkcloudya=self.webpackChunkcloudya||[]).push([[52404],{52404:function(e,t,s){s.r(t),s.d(t,{initHandler:function(){return k}});var i=s(30281);function o(e,t){return t?function(s){return(0,i.c)(t.pipe((0,i.t)(1),(0,i.o)(function(e,t){e.subscribe(new i.O(t,i.n))})),s.pipe(o(e)))}:(0,i.a)(function(t,s){return e(t,s).pipe((0,i.t)(1),(o=t,(0,i.m)(function(){return o})));var o})}function r(e,t){void 0===t&&(t=i.d);var s=(0,i.b)(e,t);return o(function(){return s})}class n{static rawUsageFrom(e,t){return(e<<16|t)>>>0}static usagePageFromRaw(e){return e>>>16}static usageFromRaw(e){return e<<16>>>16}}class a{constructor(e){this.devices=new Map,this.deviceInputSubscriptions=new Map,this.onHidInput=new i.S,this.onGetFeatureReportResponse=new i.S;const t=new i.S;this.deviceAdded=t;const s=new i.S;this.deviceRemoved=s,e.deviceAdded.subscribe(e=>{if(!this.devices.has(e.id)){this.devices.set(e.id,e);const s=e.inputHandler.inputReports.pipe((0,i.m)(t=>new i.W(e.id,n.usagePageFromRaw(t.usage),n.usageFromRaw(t.usage),t.value))).subscribe(e=>this.onHidInput.next(e));this.deviceInputSubscriptions.set(e.id,s),t.next(e)}}),e.deviceRemoved.subscribe(e=>{var t;const i=this.devices.get(e);i&&(this.devices.delete(e),null===(t=this.deviceInputSubscriptions.get(e))||void 0===t||t.unsubscribe(),this.deviceInputSubscriptions.delete(e),s.next(i))})}sendOutputUsage(e,t,s,i){var o;const r=n.rawUsageFrom(t,s);null===(o=this.devices.get(e))||void 0===o||o.outputHandler.sendOutputUsage(r,i)}setFeatureUsage(e,t,s,i){var o;const r=n.rawUsageFrom(t,s);null===(o=this.devices.get(e))||void 0===o||o.featureHandler.setFeatureUsage(r,i)}getFeatureUsage(e,t,s,o){var r;return(0,i._)(this,void 0,void 0,function*(){const a=n.rawUsageFrom(s,o),u=yield null===(r=this.devices.get(e))||void 0===r?void 0:r.featureHandler.getFeatureUsage(a);void 0!==u&&this.onGetFeatureReportResponse.next(new i.e(t,u))})}}class u{constructor(e,t){this.device=e,this.inputReportDescriptors=t;const s=new Map;this.inputReportDescriptors.forEach(e=>{e.usages.forEach((e,t)=>{s.set(t,[0])})});const o=new i.S;this.inputReports=o,this.device.oninputreport=e=>{if(e.currentTarget!==this.device)return;const t=this.inputReportDescriptors.get(e.reportId);if(!t)return;const r=new i.f.BitView(e.data.buffer);r.bigEndian=!1,Array.from(t.usages.entries(),u.makeWebHidInputReport.bind(this,r)).filter(e=>u.compareReportToCachedValue(e,s)).forEach(e=>{s.set(e.usage,e.value),o.next(e)})}}static makeWebHidInputReport(e,[t,s]){let o=s.offset,r=s.size,n=[];for(;r>0;)n.push(e.getBits(o,Math.min(r,8))),o+=8,r-=8;return n=s.onInput(n),new i.I.UsageReport(t,n)}static compareReportToCachedValue(e,t){const s=t.get(e.usage);return!s||s.length!==e.value.length||s.some((t,s)=>e.value[s]!==t)}}class c{constructor(e){this.report=e}reportSizeInBits(){return this.report.fullReportSize}reportSizeInBytes(){return Math.ceil(this.reportSizeInBits()/8)}createBitViewIfNeeded(){if(!this.bitView){const e=this.reportSizeInBytes(),t=new ArrayBuffer(e);this.bitView=new i.f.BitView(t),this.bitView.bigEndian=!1}return this.bitView}getUsageInformationOrThrow(e){if(!this.report.usages.has(e))throw new i.J(`Unable to write usage (0x${e.toString(16).padStart(8,"0")}). It is not known by the device.`,i.E.UNEXPECTED_ERROR);return this.report.usages.get(e)}writeUsage(e,t){const s=this.getUsageInformationOrThrow(e);let o=this.createBitViewIfNeeded();if(!s.absolute){const e=function(e){const t=new ArrayBuffer(e.byteLength);return new Uint8Array(t).set(new Uint8Array(e)),t}(o.buffer);o=new i.f.BitView(e)}let r=s.offset,n=s.size;return t.forEach(e=>{o.setBits(r,e,n),r+=8,n-=8}),o.buffer}}class d{constructor(e,t,s){this.device=e,this.outputReports=t,this.outputUsages=s,this.outputCacheByReportId=new Map}getReportIdForUsage(e){if(!this.outputUsages.has(e))throw new i.J(`Unknown usagePage: 0x${e.toString(16).padStart(8,"0")}.`,i.E.UNEXPECTED_ERROR);return this.outputUsages.get(e)}getReportLayoutForReportId(e){if(!this.outputReports.has(e))throw new i.J(`Unknown reportId: ${e}.`,i.E.UNEXPECTED_ERROR);return this.outputReports.get(e)}getUsageInReportForUsage(e){const t=this.getReportIdForUsage(e),s=this.getReportLayoutForReportId(t);if(!s.usages.has(e))throw new i.J(`Unknown rawUsage inside ReportLayout: ${e}.`,i.E.UNEXPECTED_ERROR);return s.usages.get(e)}getOrCreateCacheForReportId(e){if(!this.outputCacheByReportId.has(e)){const t=this.getReportLayoutForReportId(e),s=new c(t);this.outputCacheByReportId.set(e,s)}return this.outputCacheByReportId.get(e)}sendOutputUsage(e,t){return(0,i._)(this,void 0,void 0,function*(){const s=this.getReportIdForUsage(e),i=this.getOrCreateCacheForReportId(s),o=this.getUsageInReportForUsage(e).onOutput(t),r=i.writeUsage(e,o);yield this.device.sendReport(s,r)})}}class h{constructor(e=new Map,t=0){this.usages=e,this.fullReportSize=t}}class p{constructor(e,t,s){this.offset=e,this.size=t,this.absolute=s}onInput(e){return e}onOutput(e){return e}}class l{constructor(e,t,s,i){this.offset=e,this.size=t,this.absolute=s,this.rangeIndex=i}onInput(e){if(e.length>1)throw new i.J(`Usages of type ${l.name} should not hold more than 1 byte of information.`,i.E.UNEXPECTED_ERROR);return e[0]===this.rangeIndex?[1]:[0]}onOutput(e){if(e.length>1)throw new i.J(`Usages of type ${l.name} should not hold more than 1 byte of information.`,i.E.UNEXPECTED_ERROR);return e[0]>0?[this.rangeIndex]:e}}class g{constructor(e){const t=new Map;this.buildReportLayouts(e.collections,"input",t),this.inputReports=t,this.inputUsages=g.buildUsageMap(t);const s=new Map;this.buildReportLayouts(e.collections,"output",s),this.outputReports=s,this.outputUsages=g.buildUsageMap(s);const i=new Map;this.buildReportLayouts(e.collections,"feature",i),this.featureReports=i,this.featureUsages=g.buildUsageMap(i)}static buildUsageMap(e){const t=new Map;return e.forEach((e,s)=>{e.usages.forEach((e,i)=>{t.set(i,s)})}),t}buildReportLayouts(e,t,s){e.forEach(e=>{var i;null===(i=g.reportsOfType(e,t))||void 0===i||i.forEach(e=>{var t;const i=e.reportId;s.has(i)||s.set(i,new h);const o=s.get(i);let r=0;null===(t=e.items)||void 0===t||t.forEach(e=>{let t=e.usages;if(e.isRange){t=[];for(let s=e.usageMinimum;s<=e.usageMaximum;s+=1)t.push(s)}let s,i=r;if(e.isRange&&e.isArray&&(s=1),t.length>0&&t.filter(e=>o.usages.has(e)).length===t.length)return;t.forEach(t=>{let r;r=s?new l(i,e.reportSize,e.isAbsolute,s):new p(i,e.reportSize,e.isAbsolute),o.usages.set(t,r),s?s+=1:i+=e.reportSize});const n=e.reportCount*e.reportSize;o.fullReportSize+=n,r+=n})}),e.children&&this.buildReportLayouts(e.children,t,s)})}static reportsOfType(e,t){if("input"===t)return e.inputReports;if("output"===t)return e.outputReports;if("feature"===t)return e.featureReports;throw new i.J(`Unexpected report type: ${t}!`,i.E.UNEXPECTED_ERROR)}}class v{constructor(e,t,s){this.device=e,this.featureReports=t,this.featureUsages=s,this.outputCacheByReportId=new Map}getReportIdForUsage(e){if(!this.featureUsages.has(e))throw new i.J(`Unknown usagePage: 0x${e.toString(16).padStart(8,"0")}.`,i.E.UNEXPECTED_ERROR);return this.featureUsages.get(e)}getReportLayoutForReportId(e){if(!this.featureReports.has(e))throw new i.J(`Unknown reportId: ${e}.`,i.E.UNEXPECTED_ERROR);return this.featureReports.get(e)}getUsageInReportForUsage(e){const t=this.getReportIdForUsage(e),s=this.getReportLayoutForReportId(t);if(!s.usages.has(e))throw new i.J(`Unknown rawUsage inside ReportLayout: ${e}.`,i.E.UNEXPECTED_ERROR);return s.usages.get(e)}getOrCreateCacheForReportId(e){if(!this.outputCacheByReportId.has(e)){const t=this.getReportLayoutForReportId(e),s=new c(t);this.outputCacheByReportId.set(e,s)}return this.outputCacheByReportId.get(e)}getFeatureUsage(e){return(0,i._)(this,void 0,void 0,function*(){const t=this.getReportIdForUsage(e),s=yield this.device.receiveFeatureReport(t),i=this.getUsageInReportForUsage(e),o=[];for(let e=1;e<=Math.ceil(i.size/8);e+=1)o.push(s.getUint8(e));return o})}setFeatureUsage(e,t){return(0,i._)(this,void 0,void 0,function*(){const s=this.getReportIdForUsage(e),i=this.getOrCreateCacheForReportId(s),o=this.getUsageInReportForUsage(e).onOutput(t),r=i.writeUsage(e,o);yield this.device.sendFeatureReport(s,r)})}}class R{constructor(e,t,s,i){this.name=e,this.vid=t,this.pid=s,this.id=i.sessionId;const o=new g(i);this.inputReports=o.inputReports,this.outputReports=o.outputReports,this.featureReports=o.featureReports,this.inputHandler=new u(i,o.inputReports),this.outputHandler=new d(i,o.outputReports,o.outputUsages),this.featureHandler=new v(i,o.featureReports,o.featureUsages)}}class f{constructor(e,t){this.hid=e,this.broadcastChannel=t,this.deviceAddedSubject=new i.S,this.deviceAdded=this.deviceAddedSubject,this.deviceRemovedSubject=new i.S,this.deviceRemoved=this.deviceRemovedSubject}setupListeners(){this.hid.onconnect=e=>this.onConnect(e),this.hid.ondisconnect=e=>this.onDisconnect(e),this.broadcastChannel.onmessage=()=>this.getPairedDevices()}addNewDevice(e){return(0,i._)(this,void 0,void 0,function*(){if(f.hasGeneratedDeviceId(e))return;f.getOrGenerateDeviceId(e);const t=new R(e.productName,e.vendorId,e.productId,e);e.opened||(yield e.open()),this.deviceAddedSubject.next(t)})}onConnect(e){return(0,i._)(this,void 0,void 0,function*(){setTimeout(()=>(0,i._)(this,void 0,void 0,function*(){yield this.addNewDevice(e.device)}),1e3)})}onDisconnect(e){const t=f.getOrGenerateDeviceId(e.device);this.deviceRemovedSubject.next(t)}getPairedDevices(){return(0,i._)(this,void 0,void 0,function*(){(yield this.hid.getDevices()).forEach(e=>(0,i._)(this,void 0,void 0,function*(){yield this.addNewDevice(e)}))})}static hasGeneratedDeviceId(e){return void 0!==e.sessionId}static getOrGenerateDeviceId(e){if(!f.hasGeneratedDeviceId(e)){const t=new i.u(4).toString();return e.sessionId=t,t}return e.sessionId}}class w{constructor(e,t,s,i,o){this.usagePage=e,this.usage=t,this.valueType=s,this.reportType=i,this.reportSize=o}}class b{constructor(e){this.deviceManagement=e,this.events=new i.S,this.setupDeviceHandler()}setupDeviceHandler(){this.deviceManagement.deviceAdded.subscribe(e=>{this.events.next({event:"attach",id:e.id,vid:e.vid,pid:e.pid,name:e.name,serialNumber:e.id,descriptor:b.generateDescriptors(e)})}),this.deviceManagement.deviceRemoved.subscribe(e=>{this.events.next({event:"detach",id:e.id})}),this.deviceManagement.onHidInput.subscribe(e=>{this.events.next({event:"hid-input",id:e.deviceId,usagePage:e.usagePage,usage:e.usage,value:1===e.value.length?e.value[0]:e.value})}),this.deviceManagement.onGetFeatureReportResponse.subscribe(e=>{this.events.next({event:"response-hid-feature",token:e.token,value:1===e.value.length?e.value[0]:e.value})})}static generateDescriptors(e){let t=b.convertReportLayoutsToDescriptors(e.inputReports,"input");return t=t.concat(b.convertReportLayoutsToDescriptors(e.outputReports,"output")),t=t.concat(b.convertReportLayoutsToDescriptors(e.featureReports,"feature")),t}static convertReportLayoutsToDescriptors(e,t){const s=[];return e.forEach(e=>{e.usages.forEach((e,i)=>{const o=n.usagePageFromRaw(i);65280===o&&"output"===t||s.push(new w(o,n.usageFromRaw(i),e.absolute?"absolute":"relative",t,Math.ceil(e.size/8)))})}),s}}class I{constructor(e,t,s){this.deviceManagement=e,this.callLockManagement=t,this.logger=s,this.gnpLockAcquired=new i.S,this.callLockAcquired=new i.S,this.softphoneInFocus=new i.S,this.events=(0,i.g)(this.gnpLockAcquired.pipe(r(0)),this.callLockAcquired.pipe(r(0)),this.softphoneInFocus)}onNewSdkInput(e){if(!e.action)throw new i.J("Provided input has no action property.",i.E.UNEXPECTED_ERROR);switch(e.action){case"hid-output":{const t=Array.isArray(e.value)?e.value:[e.value];this.deviceManagement.sendOutputUsage(e.id,e.usagePage,e.usage,t);break}case"request-hid-feature":this.deviceManagement.getFeatureUsage(e.id,e.token,e.usagePage,e.usage);break;case"set-hid-feature":{const t=Array.isArray(e.value)?e.value:[e.value];this.deviceManagement.setFeatureUsage(e.id,e.usagePage,e.usage,t);break}case"request-gnp-lock":this.gnpLockAcquired.next({event:"response-gnp-lock",token:e.token}),(0,i.l)("GNP lock requested with WebHID backend. This should not happen!",this.logger,i.L.ERROR,i.h.NATIVE_CONSOLE);break;case"release-gnp-lock":break;case"request-call-lock":this.callLockManagement.tryAcquireCallLock(e.id).then(t=>{this.callLockAcquired.next({event:"response-call-lock",id:e.id,acquired:t})});break;case"release-call-lock":this.callLockManagement.releaseCallLock(e.id);break;case"set-softphone-info":this.softphoneInFocus.next({event:"softphone-in-focus",infocus:!1}),this.softphoneInFocus.complete();break;default:throw new i.J(`Provided action is not recognized - ${e.action}.`,i.E.UNEXPECTED_ERROR)}}}class E{constructor(e,t,s){this.navigatorLocks=e,this.logger=s,this.releaseGlobalLock=null,this.localLockedDevices=new Set,t.deviceRemoved.subscribe(e=>{this.localLockedDevices.has(e.id)&&this.releaseCallLock(e.id)})}tryAcquireCallLock(e){return(0,i._)(this,void 0,void 0,function*(){return!(yield this.checkWebLocksSupport())||(this.localLockedDevices.size>0&&!this.localLockedDevices.has(e)?(this.localLockedDevices.add(e),!0):new Promise(t=>{this.navigatorLocks.request("jabra-call-lock",{ifAvailable:!0},s=>s?(this.localLockedDevices.add(e),t(!0),new Promise(e=>{this.releaseGlobalLock=e})):(t(!1),Promise.resolve()))}))})}releaseCallLock(e){this.localLockedDevices.delete(e),this.releaseGlobalLock&&0===this.localLockedDevices.size&&this.releaseGlobalLock()}checkWebLocksSupport(){return(0,i._)(this,void 0,void 0,function*(){const e=yield this.navigatorLocks.query().catch(()=>{(0,i.l)("WebLocks unsupported. The cross-tab call lock is disabled.",this.logger,i.L.WARNING)});return Boolean(e)})}}class U{constructor(e,t,s,o){this.scanner=e,this.deviceEventHandler=t,this.sdkInputEventHandler=s,this.logger=o,this.readyEvent=new i.S,this.events=new i.i,this.events=(0,i.g)(this.readyEvent,this.deviceEventHandler.events,this.sdkInputEventHandler.events)}start(){this.readyEvent.next({event:"ready",version:null,jabraDirectInstalled:!1}),this.readyEvent.complete(),this.scanner.getPairedDevices(),this.scanner.setupListeners()}sendMessage(e){var t;null===(t=this.sdkInputEventHandler)||void 0===t||t.onNewSdkInput(e)}}function k(e){if("undefined"==typeof window)throw new i.J("WebHID is not supported outside of a browser environment.",i.E.INIT_ERROR);if(void 0===window.navigator||void 0===window.navigator.hid)throw new i.J("WebHID is not supported on this platform/browser.",i.E.INIT_ERROR);if(void 0===window.navigator.locks)throw new i.J("WebLocks is not supported on this platform/browser.",i.E.INIT_ERROR);const t=window.navigator.hid,s=window.navigator.locks,o=new BroadcastChannel(i.j.PAIRING_CHANNEL),r=new f(t,o),n=new a(r),u=new b(n),c=new I(n,new E(s,n,e));return new U(r,u,c,e)}}}]);