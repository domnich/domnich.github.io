const _version_str="1.0",EPOSVID=5013,ABLID="Sennheiser_UI_20_BL_USB",ABLCOOKIE="dsea.abl",HEADSETCOOKIE="dsea.headset";function setCookie(e,t,n=365){let o=new Date;o.setTime(o.getTime()+864e5*n);let i="expires="+o.toUTCString();document.cookie=e+"="+t+";"+i+";path=/;SameSite=None; Secure"}function getCookie(e){let t=e+"=",n=decodeURIComponent(document.cookie).split(";");for(let e=0;e<n.length;e++){let o=n[e];for(;" "==o.charAt(0);)o=o.substring(1);if(0==o.indexOf(t))return o.substring(t.length,o.length)}return""}function sendEvent(e,t){let n=new CustomEvent(e,{detail:t});document.dispatchEvent(n)}function postEvent(e,t){let n=new CustomEvent(e,{detail:t});setTimeout(function(){document.dispatchEvent(n)},0)}function dec2hexStringSimple(e){return(e+65536).toString(16).substr(-2).toUpperCase()}function dec2hexString(e){return"0x"+dec2hexStringSimple(e)}function getDeviceID(e){return getDeviceName(e).replaceAll(" ","_")}function getDeviceName(e){return e.productName}function dseaHSsetting(){this.getDefaultHeadset=function(){let e={},t={};return""===(raw=getCookie("dsea.headset"))||((t=JSON.parse(raw)).hasOwnProperty("default")&&(e.default=t.default),t.hasOwnProperty("serial")&&(e.serial=t.serial)),e}}function dseaABLsetting(){this.getABLRingtone=function(){return""===(ablraw=getCookie(ABLCOOKIE))?1:(ablr=JSON.parse(ablraw)).hasOwnProperty("ringtone")?3:1},this.getABLSound=function(){return""===(ablraw=getCookie(ABLCOOKIE))?"/common/sounds/BellPlay.wav":(abls=JSON.parse(ablraw)).hasOwnProperty("ringtone")?abls.ringtone:"/common/sounds/BellPlay.wav"},this.getABLVolume=function(){if(""===(ablraw=getCookie(ABLCOOKIE)))return 3;if((ablr=JSON.parse(ablraw)).hasOwnProperty("configuration")){let e=ablr.configuration;if(e.hasOwnProperty("volume")){let t=e.volume;if("Ringing_Volume_Off_ABL"===t)return-1;if("Ringing_Volume_Very_Low_ABL"===t)return 0;if("Ringing_Volume_Low_ABL"===t)return 2;if("Ringing_Volume_Medium_ABL"===t)return 3;if("Ringing_Volume_High_ABL"===t)return 5}}return ablr.hasOwnProperty("volume")?parseInt(ablr.volume):3},this.getABLPattern=function(){if(""===(ablraw=getCookie(ABLCOOKIE)))return 1;if((ablr=JSON.parse(ablraw)).hasOwnProperty("configuration")){let e=ablr.configuration;if(e.hasOwnProperty("pattern")){let t=e.pattern;if("Ringing_Pattern_Play_Once_ABL"===t)return 1;if("Ringing_Pattern_Play_On_Repeat_ABL"===t)return 2}}return ablr.hasOwnProperty("pattern")?parseInt(ablr.pattern):1},this.getPresenceList=function(){let e=getCookie(ABLCOOKIE);if(""!==e){let t=JSON.parse(e);if(t.hasOwnProperty("presences")){for(let e in presences=t.presences,r=[],presences)r.push(e);return r}}let t={Available:{ledcolor:"#00FF00",ledpattern:1},Away:{ledcolor:"#FFFF00",ledpattern:1},Busy:{ledcolor:"#FF0000",ledpattern:1},DoNotDisturb:{ledcolor:"#0000FF",ledpattern:1},Offline:{ledcolor:"#000000",ledpattern:0}},n={};return n.presences=t,setCookie(ABLCOOKIE,JSON.stringify(n)),["Available","Busy","Away","DoNotDisturb","Offline"]},this.getPresenceColor=function(e){let t=getCookie(ABLCOOKIE);if(""!==t){let n=JSON.parse(t);if(n.hasOwnProperty("presences")){let t=n.presences;if(t.hasOwnProperty(e))return t[e].ledcolor}}return"Available"==e?"#00FF00":"Away"==e?"#FFFF00":""==e?"#00FF00":"#FF0000"},this.getABLInACallColor=function(){let e=getCookie(ABLCOOKIE);if(""!==e){let t=JSON.parse(e);if(t.hasOwnProperty("configuration")){let e=t.configuration;if(e.hasOwnProperty("In_a_Call_ABL"))return FindColor(e.In_a_Call_ABL)}if(t.hasOwnProperty("inacall")){let e=t.inacall;if(e.hasOwnProperty("ledcolor"))return e.ledcolor}}return"#FF0000"},this.getABLOutgoingColor=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))){if((ablr=JSON.parse(ablraw)).hasOwnProperty("configuration")){let e=ablr.configuration;if(e.hasOwnProperty("Outgoing_call_ABL"))return FindColor(e.Outgoing_call_ABL)}if(ablr.hasOwnProperty("outgoingcall")){let e=ablr.outgoingcall;if(e.hasOwnProperty("ledcolor"))return e.ledcolor}}return"#FF0000"},this.getABLIncomingColor=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))){if((ablr=JSON.parse(ablraw)).hasOwnProperty("configuration")){let e=ablr.configuration;if(e.hasOwnProperty("Incoming_Call_ABL"))return FindColor(e.Incoming_Call_ABL)}if(ablr.hasOwnProperty("incomingcall")){let e=ablr.incomingcall;if(e.hasOwnProperty("ledcolor"))return e.ledcolor}}return"#FF0000"},this.getABLPresentingColor=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))&&(ablr=JSON.parse(ablraw)).hasOwnProperty("presenting")){let e=ablr.presenting;if(e.hasOwnProperty("ledcolor"))return e.ledcolor}return"#FF00FF"},this.getABLIMNotificationColor=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))&&(ablr=JSON.parse(ablraw)).hasOwnProperty("imnotification")){let e=ablr.imnotification;if(e.hasOwnProperty("ledcolor"))return e.ledcolor}return"#0000FF"},this.getABLInACallPattern=function(){let e=getCookie(ABLCOOKIE);if(""!==e){let t=JSON.parse(e);if(t.hasOwnProperty("inacall")){let e=t.inacall;if(e.hasOwnProperty("ledpattern"))return e.ledpattern}}return 1},this.getABLOutgoingPattern=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))&&(ablr=JSON.parse(ablraw)).hasOwnProperty("outgoingcall")){let e=ablr.outgoingcall;if(e.hasOwnProperty("ledpattern"))return e.ledpattern}return 2},this.getABLIncomingPattern=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))&&(ablr=JSON.parse(ablraw)).hasOwnProperty("incomingcall")){let e=ablr.incomingcall;if(e.hasOwnProperty("ledpattern"))return e.ledpattern}return 2},this.getABLPresentingPattern=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))&&(ablr=JSON.parse(ablraw)).hasOwnProperty("presenting")){let e=ablr.presenting;if(e.hasOwnProperty("ledpattern"))return e.ledpattern}return 1},this.getABLIMNotificationPattern=function(){if(""!==(ablraw=getCookie(ABLCOOKIE))&&(ablr=JSON.parse(ablraw)).hasOwnProperty("imnotification")){let e=ablr.imnotification;if(e.hasOwnProperty("ledpattern"))return e.ledpattern}return 2},this.getPresencePattern=function(e){let t=getCookie(ABLCOOKIE);if(""!==t){let n=JSON.parse(t);if(n.hasOwnProperty("presences")){let t=n.presences;if(t.hasOwnProperty(e)&&t[e].hasOwnProperty("ledpattern"))return t[e].ledpattern}}return 1}}function dseacallcontrolsdk(e="",t="",n="",o=0){let i,r,a,s,l=null,c=this;c.brand=e,c.name=t,c.version=n,c.forceHID=o;let g=new log("DarkSeaGreen","LightSeaGreen");g.message("dseacallcontrollibrary initialized");let d=!1,u=!1,f=!1,p=!1;o>0?(g.message("Forcing webHID"),navigator.hid&&(l=new webhid(c.brand,c.name,c.version,!0),postEvent("LoginStatusChanged","EstablishConnection"))):((i=new WebSocket("wss://127.0.0.1:41088")).onopen=function(){g.message("Socket Opened"),d=!0},i.onmessage=function(e){if(!d)return;let t=JSON.parse(e.data);"Acknowledgement"===t.EventType?h(t):"Notification"===t.EventType?m(t):g.error("Unhandled Acknowledgement received "+e.data)},i.onclose=function(){g.message("Socket Closed"),d=!1,navigator.hid&&c.forceHID>=0&&(l=new webhid(c.brand,c.name,c.version),postEvent("LoginStatusChanged","EstablishConnection"))});var h=function(e){if(r=e.Event,a=e.CallID,0===parseInt(e.ReturnCode)){if("EstablishConnection"===r)return g.message("acknowledgement EstablishConnection","DarkSeaGreen"),postEvent("LoginStatusChanged","EstablishConnection"),u=!0,void C();if("TerminateConnection"===r)return g.message("acknowledgement TerminateConnection","DarkSeaGreen"),postEvent("LoginStatusChanged","TerminateConnection"),void(u=!1);if(u){if("SystemInformation"===r)return g.message("acknowledgement SystemInformation: "+e.ProductName+" version: "+e.ProductVersion,"DarkSeaGreen"),void postEvent("SystemInformation",e.ProductName+" v. "+e.ProductVersion);if("SPLoggedIn"===r)return g.message("acknowledgement SPLoggedIn","DarkSeaGreen"),postEvent("LoginStatusChanged","SPLoggedIn"),postEvent("BLsPresent",-1),void(f=!0);if("SPLoggedOut"===r)return g.message("acknowledgement SPLoggedOut","DarkSeaGreen"),postEvent("LoginStatusChanged","SPLoggedOut"),postEvent("BLsPresent",0),void(f=!1);f&&(void 0===a?g.message("acknowledgement:"+r,"DarkSeaGreen"):(g.message("acknowledgement:"+r+" callid:"+a,"DarkSeaGreen"),"IncomingCall"===r&&sendEvent("IncomingCall",a),"InCallAccepted"==r&&sendEvent("InCallAccepted",a)))}}else g.error("ErrorCode "+r+" ("+e.ReturnCode+")")},m=function(e){r=e.Event,a=e.CallID,"SocketConnected"===r?(g.message("notification SocketConnected","YellowGreen"),postEvent("LoginStatusChanged","SocketConnected"),y()):"HeadsetConnected"===r?(g.message("notification HeadsetConnected","YellowGreen"),postEvent("HeadsetConnected",e.HeadsetName)):"HeadsetDisconnected"===r?(g.message("notification HeadsetDisconnected","YellowGreen"),postEvent("HeadsetDisconnected",e.HeadsetName)):"MuteSoftphone"===r?(g.message("notification MuteSoftphone","YellowGreen"),postEvent("MuteMicrophone",!0)):"UnmuteSoftphone"===r?(g.message("notification UnmuteSoftphone","YellowGreen"),postEvent("MuteMicrophone",!1)):"InCallAccepted"===r?(g.message("notification InCallAccepted "+a,"YellowGreen"),postEvent("AcceptCall",a)):"InCallRejected"===r?(g.message("notification InCallRejected","YellowGreen"),postEvent("RejectCall",a)):"CallEnded"===r?(g.message("notification CallEnded","YellowGreen"),postEvent("EndCall",a)):"CallHold"===r?(g.message("notification CallHold","YellowGreen"),postEvent("HoldCall",a)):"HeldCallResumed"===r?(g.message("notification HeldCallResumed","YellowGreen"),postEvent("ResumeCall",a)):"ListenerClosed"===r?(g.message("ListenerClosed received","YellowGreen"),c.SendTerminateEvent()):"BLsPresent"===r?(g.message("notification BLsPresent","YellowGreen"),postEvent("BLsPresent",e.ablDevices)):"HeadsetAvailable"===r?(g.message("notification HeadsetAvailable","YellowGreen"),postEvent("HeadsetAvailable",{name:e.HeadsetName,id:e.HeadsetPath,serial:"",firmware:"",vid:"",pid:""})):"HeadsetRemoved"===r?(g.message("notification HeadsetRemoved","YellowGreen"),postEvent("HeadsetRemoved",{name:e.HeadsetName,id:e.HeadsetPath,serial:"",firmware:"",vid:"",pid:""})):"Redial"===r?(g.message("notification Redial","YellowGreen"),postEvent("Redial",0)):"Offhook"===r?(g.message("notification Offhook","YellowGreen"),postEvent("Offhook",0)):"InCallAcceptedOnOffhook"===r?(g.message("notification InCallAcceptedOnOffhook","YellowGreen"),postEvent("InCallAcceptedOnOffhook",e)):null==a?g.message("notification:"+r,"YellowGreen"):g.message("notification:"+r+" callid:"+a,"YellowGreen")},v=function(e){d&&i.send(JSON.stringify(e))},y=function(){g.message("sending EstablishConnection"),(s={Event:"EstablishConnection",EventType:"Request",SPIconImage:"SPImage.ico",AudioDeviceChangesSupport:"Yes",DNDOption:"Yes",MuteSupport:"Yes",RedialSupport:"Yes",OffHookSupport:"Yes"}).SPName="Softphone::"+c.name,v(s)},C=function(){d||null===l?(g.message("sending SystemInformation"),v({Event:"SystemInformation",EventType:"Request"})):postEvent("SystemInformation","DSEA Call Control JS Library v. 1.0")};this.SendLoginEvent=function(){if(!d&&null!==l)return l.open(),postEvent("LoginStatusChanged","SPLoggedInHID"),void C();u&&(g.message("sending SPLoggedIn"),v({Event:"SPLoggedIn",EventType:"Request"}))},this.SendLogoutEvent=function(){if(!d&&null!==l)return l.close(),void postEvent("LoginStatusChanged","SPLoggedOutHID");f&&(g.message("sending SPLoggedOut"),v({Event:"SPLoggedOut",EventType:"Request"}))},this.SendTerminateEvent=function(){if(!d&&null!==l)return l.close(),void sendEvent("LoginStatusChanged","TerminateConnection");f&&this.SendLogoutEvent(),u&&(g.message("sending TerminateConnection"),v({Event:"TerminateConnection",EventType:"Request"}))},this.SendMuteStatus=function(e){d||null===l?f&&((p=e)?(g.message("sending MuteHeadset"),v({Event:"MuteHeadset",EventType:"Request"})):(g.message("sending UnmuteHeadset"),v({Event:"UnmuteHeadset",EventType:"Request"}))):l.mute(e)},this.SendIncomingCallEvent=function(e){d||null===l?f&&(g.message("sending IncomingCall "+e),v({Event:"IncomingCall",EventType:"Request",CallID:e})):l.incoming(e)},this.SendOutgoingCallEvent=function(e){d||null===l?f&&(g.message("sending OutgoingCall "+e),v({Event:"OutgoingCall",EventType:"Request",CallID:e})):l.outgoing(e)},this.SendEndCallEvent=function(e){d||null===l?f&&(g.message("sending CallEnded "+e),v({Event:"CallEnded",EventType:"Request",CallID:e})):l.end(e)},this.SendHoldCallEvent=function(e){d||null===l?f&&(g.message("sending CallHold "+e),v({Event:"CallHold",EventType:"Request",CallID:e})):l.hold(e)},this.SendActiveCallEvent=function(e){d||null===l?f&&(g.message("sending InCallAccepted"),v({Event:"InCallAccepted",EventType:"Request",CallID:e})):l.active(e)},this.getBLPresenceList=function(){return d||null===l?u?["Available","Busy","Away","DoNotDisturb","Offline"]:[]:myABLsetting.getPresenceList()},this.SendPresenceEvent=function(e){d||null===l?f&&(g.message("sending SendPresenceEvent "+e),v({Event:"SetPresence",EventType:"Request",State:e})):l.setBLPresence(e)},this.SendPresentingEvent=function(e){d||null===l?f&&(g.message("sending SendPresentingEvent "+e),v({Event:"SetPresenting",EventType:"Request",State:e})):l.setPresenting(e)},this.SendIMEvent=function(){d||null===l?f&&(g.message("sending SetIMEvent"),v({Event:"SetIMEvent",EventType:"Request"})):l.setIMEvent()},this.SendActiveDeviceChanged=function(e,t){var n;if(!d&&null!==l)return void l.headset(t);if(!f)return;let o=1;e||(o=0);let i=((n=t).charCodeAt(0)>47&&58>n.charCodeAt(0)&&"-"===n[1]&&" "===n[2]&&(n=n.substring(3)),n.toLowerCase());g.message("sending ActiveDeviceChanged "+i+" "+o),v({Event:"ActiveDeviceChanged",EventType:"Request",HSSTATUS:o,HeadsetPath:i})},this.AllowHS=function(){d||null===l||l.select()},this.AllowBL=function(){d||null===l||l.selectBL()}}function log(e,t){let n=this;n.active=!0,n.color1=e,n.color2=t;let o="padding: 3px;height: 18px; line-height: 18px;font-size: 12px;",i="border:1px solid black;",r="border-top:1px solid black;border-left:1px solid black;border-right:1px solid black;";this.activate=function(e=!0){n.active=e},this.image=function(e,t=100){if(n.active){var o=new Image;o.onload=function(){var o=["font-size: 1px;","border: 1px solid black;","padding: "+t+"px "+t+"px;","background: "+n.color2+" url("+e+") no-repeat;","background-size: contain;"].join(" ");console.log("%c ",o)},o.src=e}},this.led=function(e,t,r,a){if(n.active){for(;e.length<75;)e+=" ";var s=[];s.push("%c   %c %c"+e),s.push(o+"border: 1px solid black;border-radius: 50%;background: rgb("+t+","+r+","+a+")"),s.push(o),s.push(o+i+"background:"+n.color2+";"),console.log.apply(this,s)}},this.error=function(e){this.message(e,"Crimson")},this.connection=function(e){this.message(e,"DarkKhaki")},this.init=function(e){this.message(e,"Khaki")},this.message=function(e,t=""){if(n.active)for(""===t&&(t=n.color2);e.length<81;)(e=" "+e).length<81&&(e+=" ")},this.report=function(e,t,a,s="",l=""){if(n.active){""===s&&(s=n.color1),""===l&&(l=n.color2);for(var c="%c"+t+" ("+a+")";c.length<40;)c+=" ";for(s=0;s<e.length;s++){for(c+="%c\n",item="%c "+s+" "+e[s][0];item.length<40-e[s][1].toString().length-2;)item+=" ";item+=" "+e[s][1]+" ",c+=item}margin="","INPUT"===t.toUpperCase().substr(0,5)&&(margin="margin-left: 283px;");var g=[];for(g.push(c),g.push(o+r+margin+"background:"+s+";"),t=0;t<e.length;t++)g.push(""),t===e.length-1?g.push(o+i+margin+"background:"+l+";"):g.push(o+r+margin+"background:"+l+";");console.log.apply(this,g)}},this.jsonreport=function(e,t){if(n.active){for(var a="%c"+e;a.length<83;)a+=" ";for(var s in cnt=0,t)if(Array.isArray(t[s])){if("configSettings"===s)for(var l in t[s]){for(a+="%c\n",line=t[s][l].FeatureName;line.length<39;)line=" "+line;for(line=" "+line,line+=" : ",y=0,str=t[s][l].FeatureValue;line.length<80;)y>=str.length?line+=" ":line+=str[y++];line+=" ",a+="%c"+line,cnt++}}else{for(a+="%c\n",line=s;line.length<39;)line=" "+line;for(line=" "+line,line+=" : ",y=0,str="",null!==t[s]&&(str=t[s].toString());line.length<80;)y>=str.length?line+=" ":line+=str[y++];line+=" ",a+="%c"+line,cnt++}var c=[];for(c.push(a),c.push(o+r+"background:"+n.color1+";"),e=0;e<cnt;e++)c.push(""),e===cnt-1?c.push(o+i+"background:"+n.color2+";"):c.push(o+r+"background:"+n.color2+";");console.log.apply(this,c)}}}function abl(e){let t=this;t.callback=e;let n=[],o=null;function a(e){if(len=parseInt((inputReportBuffer=new Uint8Array(e.data.buffer))[0]),cmd=parseInt(inputReportBuffer[1]),1===cmd&&8&inputReportBuffer[27])for(i=0;i<n.length;i++)n[i].device==e.device&&(n[i].ringtone=3)}this.color=async function(e,t){if(7===e.length&&"#"===e[0])for(time=256,4==t&&(t=2,time=1024),r=(16711680&(colordec=parseInt(e.replace("#","0x"))))>>16,g=(65280&colordec)>>8,e=(255&colordec)>>0,buffer=new Uint8Array(63),buffer.fill(0),x=0,buffer[x++]=18,buffer[x++]=2,buffer[x++]=r,buffer[x++]=g,buffer[x++]=e,buffer[x++]=r,buffer[x++]=g,buffer[x++]=e,buffer[x++]=t,buffer[x++]=255,buffer[x++]=255,buffer[x++]=255,buffer[x++]=255,2===parseInt(t)?(buffer[x++]=(255&time)>>0,buffer[x++]=(65280&time)>>8,buffer[x++]=(255&time)>>0,buffer[x++]=(65280&time)>>8):3===parseInt(t)&&(buffer[x++]=255,buffer[x++]=255,buffer[x++]=255,buffer[x++]=255),i=0;i<n.length;i++)n[i].device.opened&&n[i].device.sendReport(1,buffer).catch(function(e){o.error("Error in SendReport abl::color "+e)})},this.select=async function(){if(navigator.hid){if(0!==(device=await navigator.hid.requestDevice({filters:filters=[{vendorId:5013,productId:116}]})).length){for(i=0,dev=device[0],found=!1;i<n.length;i++)dev===n[i].device&&(found=!0);found||(o.message("Adding device "+dev.productName),addDevice(dev))}}else alert("navigator.hid not defined - Use Chrome 89+ or install EPOS Connect")},this.play=function(e,t,r){for((buffer=new Uint8Array(63)).fill(0),x=0,buffer[x++]=9,buffer[x++]=4,buffer[x++]=e,buffer[x++]=t,buffer[x++]=(255&r)>>0,buffer[x++]=(65280&r)>>8,buffer[x++]=(16711680&r)>>16,buffer[x++]=(4278190080&r)>>24,i=0;i<n.length;i++)n[i].device.opened&&(buffer[2]=n[i].ringtone,n[i].device.sendReport(1,buffer).catch(function(e){o.error("Error in SendReport abl::play "+e)}))},this.open=async function(){await init(),t.callback("loaded")},this.close=async function(){for(t.color("#000000",0),t.play(0,0,0),i=n.length-1;i>=0;i--)n[i].device.opened&&(o.message("Device removed "+n[i].device.productName),n[i].device.close(),n.splice(i,1));n=[],t.callback("devices",0)},navigator.hid&&(navigator.hid.addEventListener("connect",async({device:e})=>{116===e.productId&&(o.connection(`HID connected: ${e.productName}`),addDevice(e))}),navigator.hid.addEventListener("disconnect",({device:e})=>{if(116===e.productId)for(o.connection(`HID disconnected: ${e.productName}`),i=0;i<n.length;i++)if(n[i].device===e)return o.message("Device removed "+e.productName),n[i].device.close(),n.splice(i,1),void t.callback("devices",n.length)})),addDevice=async function(e){116===e.productId&&e.open().then(function(){if(e.opened){var o;let i={};i.device=e,i.serial="",i.firmware="",i.wait=0,i.number=n.length,i.vid=parseInt(5013),i.pid=parseInt(116),i.id=getDeviceID(e),i.ringtone=0,n.push(i),t.callback("devices",n.length),t.color("#000000",0),e.oninputreport=a,o=e,(buffer=new Uint8Array(63)).fill(0),x=0,buffer[x++]=3,buffer[x++]=1,o.sendReport(1,buffer).catch(function(e){console.log("Error in status "+e)})}})},init=async function(){if(navigator.hid){let e=await navigator.hid.getDevices(),t=await e.map(async e=>await addDevice(e));await Promise.all(t)}},o=new log("PaleVioletRed","LightPink")}function webhid(e="",t="",n=""){let o=this;o.name=t,o.brand=e,o.version=n,myABLsetting=new dseaABLsetting,myHSsetting=new dseaHSsetting;let i=null,r=null,a="",s=!1,l=!0,c=[],g=!0,d=!1,u=new Map;async function f(){defaultHeadset=myHSsetting.getDefaultHeadset();for(let e=1;e<c.length;e++)if(c[e].id===defaultHeadset.default){c.splice(0,0,c.splice(e,1)[0]),i.message("New device selected "+c[0].name),postEvent("HeadsetConnected",c[0].name);break}h()}async function p(){if(!navigator.hid)return;let e=await navigator.hid.getDevices(),t=await e.map(async e=>await addNewHeadset(e));await Promise.all(t)}async function h(){0!==c.length?(g&&(i.message("Device in use by SDK is: "+c[0].name),postEvent("HeadsetConnected",c[0].name)),m()):i.message("No headset connected")}function m(e=-1){let t=e;if(-1==t&&(t=L()),byte=0,1===t?(r.color(myABLsetting.getABLIncomingColor(),myABLsetting.getABLIncomingPattern()),0!==c.length&&(byte|=c[0].led_ring|c[0].led_ringer)):8===t?(s?r.color(myABLsetting.getABLPresentingColor(),myABLsetting.getABLPresentingPattern()):r.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==c.length&&(byte|=c[0].led_offhook)):10===t?(s?r.color(myABLsetting.getABLPresentingColor(),myABLsetting.getABLPresentingPattern()):r.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==c.length&&(byte|=c[0].led_offhook|c[0].led_hold)):9===t?(s?r.color(myABLsetting.getABLPresentingColor(),myABLsetting.getABLPresentingPattern()):r.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==c.length&&(byte|=c[0].led_offhook|c[0].led_ring|c[0].led_ringer)):11===t?(s?r.color(myABLsetting.getABLPresentingColor(),myABLsetting.getABLPresentingPattern()):r.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==c.length&&(byte|=c[0].led_offhook|c[0].led_ring|c[0].led_hold|c[0].led_ringer)):4===t?(r.color(myABLsetting.getABLOutgoingColor(),myABLsetting.getABLOutgoingPattern()),0!==c.length&&(byte|=c[0].led_offhook)):6===t?(r.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==c.length&&(byte|=c[0].led_offhook|c[0].led_hold)):5===t?(r.color(myABLsetting.getABLOutgoingColor(),myABLsetting.getABLOutgoingPattern()),0!==c.length&&(byte|=c[0].led_offhook|c[0].led_ring|c[0].led_ringer)):7===t?(r.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==c.length&&(byte|=c[0].led_offhook|c[0].led_ring|c[0].led_hold|c[0].led_ringer)):2===t?(r.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==c.length&&(byte|=c[0].led_hold)):3===t?(r.color(myABLsetting.getABLInACallColor(),myABLsetting.getABLInACallPattern()),0!==c.length&&(byte|=c[0].led_ring|c[0].led_hold|c[0].led_ringer)):""!=a?r.color(myABLsetting.getPresenceColor(a),myABLsetting.getPresencePattern(a)):r.color(myABLsetting.getPresenceColor("Available"),myABLsetting.getPresencePattern("Available")),d&&0!==c.length&&(byte|=c[0].led_mute|c[0].led_microphone),0!==c.length&&5013===c[0].device.vendorId&&(byte|=128),0!==c.length&&c[0].outputReportID>0&&g&&(function(e,t){let n=[["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0]];for(s=0;s<8;s++)c[0].led_offhook===1<<s&&(n[s][0]="Offhook",(t&c[0].led_offhook)>0&&(n[s][1]=1)),c[0].led_microphone===1<<s&&(n[s][0]="Microphone",(t&c[0].led_microphone)>0&&(n[s][1]=1)),c[0].led_ring===1<<s&&(n[s][0]="Ring",(t&c[0].led_ring)>0&&(n[s][1]=1)),c[0].led_ringer===1<<s&&(n[s][0]="Ringer",(t&c[0].led_ringer)>0&&(n[s][1]=1)),c[0].led_mute===1<<s&&(n[s][0]="Mute",(t&c[0].led_mute)>0&&(n[s][1]=1)),c[0].led_online===1<<s&&(n[s][0]="Online",(t&c[0].led_online)>0&&(n[s][1]=1)),c[0].led_hold===1<<s&&(n[s][0]="Hold",(t&c[0].led_hold)>0&&(n[s][1]=1)),128==1<<s&&5013===c[0].device.vendorId&&(n[s][0]="Vendor Page",(128&t)>0&&(n[s][1]=1));i.report(n,"Output Report "+c[0].outputReportID,e)}(I(t),byte),c[0].lastOutputReportTime=Date.now(),c[0].lastOutputReport=byte,c[0].device.sendReport(c[0].outputReportID,new Uint8Array([byte])).catch(function(e){i.error("Error in SendReport webhid::updatehs "+e)})),1===t){if(l){l=!1;let e=myABLsetting.getABLPattern(),t=myABLsetting.getABLRingtone();-1===myABLsetting.getABLVolume()?r.play(t,0,0):1===e?r.play(t,3,1):2===e&&r.play(t,1,0)}}else l=!0,r.play(0,0,0)}function v(){for(let e of u.keys())"active"===u.get(e).state&&postEvent("EndCall",e)}function y(){for(let e of u.keys())"outgoing"===u.get(e).state&&postEvent("RejectCall",e)}function C(){for(let e of u.keys())"active"===u.get(e).state&&postEvent("HoldCall",e)}function A(){for(let e of(oldest=Date.now(),id="",u.keys()))"incoming"===u.get(e).state&&u.get(e).created<oldest&&(oldest=u.get(e).created,id=e);""!==id&&postEvent("AcceptCall",id)}function b(){for(let e of(oldest=Date.now(),id="",u.keys()))"onhold"===u.get(e).state&&u.get(e).active<oldest&&(oldest=u.get(e).active,id=e);""!==id&&postEvent("ResumeCall",id)}function O(e){let t=e.reportId,n=e.data.getUint8(0);e.device===c[0].device&&(state=L(),t===c[0].inputReportID)&&(function(e,t){let n=[["",0],["",0],["",0],["",0],["",0],["",0],["",0],["",0]];for(s=0;s<8;s++)c[0].telephony_hook===1<<s&&(n[s][0]="Hook",(t&c[0].telephony_hook)>0&&(n[s][1]=1)),c[0].telephony_flash===1<<s&&(n[s][0]="Flash",(t&c[0].telephony_flash)>0&&(n[s][1]=1)),c[0].telephony_redial===1<<s&&(n[s][0]="Redial",(t&c[0].telephony_redial)>0&&(n[s][1]=1)),c[0].telephony_mute===1<<s&&(n[s][0]="Mute",(t&c[0].telephony_mute)>0&&(n[s][1]=1)),c[0].telephony_drop===1<<s&&(n[s][0]="Drop",(t&c[0].telephony_drop)>0&&(n[s][1]=1));i.report(n,"Input Report "+c[0].inputReportID,e)}(I(state),n),(c[0].lastInputReport&c[0].telephony_mute)>0?0==(n&c[0].telephony_mute)?(i.message("MUTE"),postEvent("MuteMicrophone",d=!d)):i.error("ABORTED MUTE"):(c[0].lastInputReport&c[0].telephony_redial)>0?0==(n&c[0].telephony_redial)?(i.message("REDIAL"),postEvent("Redial",0)):i.error("ABORTED REDIAL"):(c[0].lastInputReport&c[0].telephony_flash)>0?0==(n&c[0].telephony_flash)?(i.message("FLASH"),4===state?y():5===state?(y(),setTimeout(function(){A()},200)):8===state?C():9===state?(C(),setTimeout(function(){A()},200)):2===state||3===state||10===state||6===state||11===state||7===state?b():i.message("IGNORED")):i.error("ABORTED FLASH"):(c[0].lastInputReport&c[0].telephony_drop)>0?0==(n&c[0].telephony_drop)?(i.message("DROP"),9===state||11===state||5===state||7===state||1===state||3===state?function(){for(let e of(oldest=Date.now(),id="",u.keys()))"incoming"===u.get(e).state&&u.get(e).created<oldest&&(oldest=u.get(e).created,id=e);""!==id&&postEvent("RejectCall",id)}():i.message("IGNORED")):i.error("ABORTED DROP"):Date.now()-c[0].lastOutputReportTime<1e3&&(0===n||n===c[0].telephony_hook)?i.message(0===n?"HOOK ON STATUS":"HOOK OFF STATUS"):0==(c[0].lastInputReport&c[0].telephony_hook)&&n===c[0].telephony_hook?(i.message("HOOK OFF"),0===state?(m(4),postEvent("Offhook",c[0].name),setTimeout(function(){m()},1e3)):2===state?b():1===state||3===state?A():i.message("IGNORED")):(c[0].lastInputReport&c[0].telephony_hook)>0&&0===n?(i.message("HOOK ON"),8===state?v():10===state?(v(),setTimeout(function(){b()},200)):9===state||11===state?(v(),setTimeout(function(){A()},200)):4===state?y():6===state?(y(),setTimeout(function(){b()},200)):5===state||7===state?(y(),setTimeout(function(){A()},200)):i.message("IGNORED")):(n&c[0].telephony_redial)>0?i.message("REDIAL PART 1"):(n&c[0].telephony_mute)>0?i.message("MUTE PART 1"):(n&c[0].telephony_flash)>0?i.message("FLASH PART 1"):(n&c[0].telephony_drop)>0&&i.message("DROP PART 1"),c[0].lastInputReport=n)}function I(e){switch(e){case 0:return"IDLE";case 1:return"INCOMING";case 2:return"HOLDING";case 3:return"INCOMING_HOLDING";case 4:return"OUTGOING";case 5:return"OUTGOING_INCOMING";case 6:return"OUTGOING_HOLDING";case 7:return"OUTGOING_INCOMING_HOLDING";case 8:return"ACTIVE";case 9:return"ACTIVE_INCOMING";case 10:return"ACTIVE_HOLDING";case 11:return"ACTIVE_INCOMING_HOLDING";default:return"UNKNOWN"}}function L(){let e=0,t=0,n=0,o=0;for(let i of u.keys())"incoming"==u.get(i).state&&e++,"outgoing"==u.get(i).state&&t++,"active"==u.get(i).state&&n++,"onhold"==u.get(i).state&&o++;return e>0&&0===t&&0===n&&0===o?1:e>0&&0===t&&0===n&&o>0?3:0===e&&0===t&&1===n&&0===o?8:0===e&&0===t&&1===n&&o>0?10:e>0&&0===t&&1===n&&0===o?9:e>0&&0===t&&1===n&&o>0?11:0===e&&1===t&&0===n&&0===o?4:0===e&&1===t&&0===n&&o>0?6:e>0&&1===t&&0===n&&0===o?5:e>0&&1===t&&0===n&&o>0?7:0===e&&0===t&&0===n&&o>0?2:0===e&&0===t&&0===n&&0===o?0:12}this.incoming=function(e){if(u.has(String(e))){if("incoming"===u.get(String(e)).state)return}else u.set(String(e),{state:"none",created:Date.now(),active:0,type:"incoming",started:new Date});u.get(String(e)).state="incoming",m()},this.outgoing=function(e){if(u.has(String(e))){if("outgoing"===u.get(String(e)).state)return}else u.set(String(e),{state:"none",created:Date.now(),active:0,type:"outgoing",started:new Date});for(let t of u.keys())if(t!==String(e)){if("outgoing"===u.get(t).state)return o.end(String(t)),postEvent("EndCall",t),void setTimeout(function(){o.outgoing(e)},200);if("active"===u.get(t).state)return o.hold(String(t)),postEvent("HoldCall",t),void setTimeout(function(){o.outgoing(e)},200)}u.get(String(e)).state="outgoing",m()},this.active=function(e){if(u.has(String(e))){if("active"===u.get(String(e)).state)return}else u.set(String(e),{state:"none",created:Date.now(),active:0,type:"other",started:new Date});for(let t of u.keys())if(t!==String(e)){if("outgoing"===u.get(t).state)return o.end(String(t)),postEvent("EndCall",t),void setTimeout(function(){o.active(e)},200);if("active"===u.get(t).state)return o.hold(String(t)),postEvent("HoldCall",t),void setTimeout(function(){o.active(e)},200)}u.get(String(e)).state="active",u.get(String(e)).active=Date.now(),m()},this.hold=function(e){if(u.has(String(e))){if("onhold"===u.get(String(e)).state)return}else u.set(String(e),{state:"none",created:Date.now(),active:Date.now(),type:"other",started:new Date});u.get(String(e)).state="onhold",m()},this.end=function(e){u.has(String(e))&&(u.delete(String(e)),m())},this.open=async function(){!async function(){r.open(),await p(),setTimeout(f,2e3)}()},this.close=function(){(function(){if(0!==c.length){for(g&&postEvent("HeadsetDisconnected",c[0].name),s=0;s<c.length;s++)c[s].device.sendReport(c[0].outputReportID,new Uint8Array([0])).catch(function(e){i.error("Error in SendReport webhid::closehslist "+e)}),c[s].device.close(),c[s].device.oninputreport=null;c=[]}})(),r.close()},this.mute=function(e){d=e,m()},this.select=async function(){if(navigator.hid){if(0!==(devices=await navigator.hid.requestDevice({filters:filters=[{usagePage:65535,vendorId:5013},{usagePage:65368,vendorId:5013},{usagePage:11}]})).length){for(s=0,dev=devices[0];s<c.length&&c[s].device!==dev;s++);if(g=!0,s===c.length)m(0),await addNewHeadset(dev);else{if(!(s>0))return;m(0),c.splice(0,0,c.splice(s,1)[0])}h()}}else alert("navigator.hid not defined - Use Chrome 89+ or install EPOS Connect")},this.headset=async function(e){for(let t=0;t<c.length;t++)if(c[t].name===e)return g=!0,0!==t&&(m(0),c.splice(0,0,c.splice(t,1)[0])),h(),void i.message("New device selected "+c[0].name);m(0),i.message("Non Supported device selected "+e),c.length&&postEvent("HeadsetDisconnected",c[0].name),g=!1,postEvent("HeadsetConnected",e)},this.selectBL=function(){r.select()},this.setBLPresence=function(e){a=e,m()},this.setPresenting=function(e){s=e,m()},this.setIMEvent=function(){r.color(myABLsetting.getABLIMNotificationColor(),myABLsetting.getABLIMNotificationPattern()),setTimeout(function(){m()},5e3)},addNewHeadset=async function(e){var t;for(A=0,found=!1;A<e.collections.length;A++)(5013===e.vendorId&&(65535===e.collections[A].usagePage||65368===e.collections[A].usagePage)||11===e.collections[A].usagePage)&&(found=!0);if(!found||(await e.open(),!e.opened))return;e.oninputreport=O;let n={};n.device=e,n.serial="",n.firmware="",n.vid=parseInt(e.vendorId),n.pid=parseInt(e.productId),n.id=getDeviceID(e),n.name=getDeviceName(e),n.slave1id="",n.slave1name="",n.slave1firmware="",n.slave1serial="",n.slave2id="",n.slave2name="",n.slave2firmware="",n.slave2serial="",n.slave1pid=0,n.slave2pid=0,n.Commands=[],n.inputReportID=0,n.outputReportID=0,n.telephony_hook=0,n.telephony_flash=0,n.telephony_redial=0,n.telephony_mute=0,n.telephony_drop=0,n.led_ringer=0,n.led_offhook=0,n.led_microphone=0,n.led_ring=0,n.led_mute=0,n.led_online=0,n.led_hold=0,n.lastOutputReportTime=0,n.lastOutputReport=0,n.lastInputReport=0,c.unshift(n),async function(){let e=null;for(A=0;A<c[0].device.collections.length;A++)65535===c[0].device.collections[A].usagePage&&(e=c[0].device.collections[A]);if(null===e)for(A=0;A<c[0].device.collections.length;A++)65368===c[0].device.collections[A].usagePage&&(e=c[0].device.collections[A]);if(null===e)for(A=0;A<c[0].device.collections.length;A++)11===c[0].device.collections[A].usagePage&&(e=c[0].device.collections[A]);if(null===e)return void i.error("Device does not have Telephony Collection, using defaults");let t=[];for(p=0;p<e.outputReports.length;p++)for(A=0,reportPos=0;A<e.outputReports[p].items.length;A++)for(b=0;b<e.outputReports[p].items[A].usages.length;b++){if(usagePage=(16711680&e.outputReports[p].items[A].usages[b])>>16,usage=255&e.outputReports[p].items[A].usages[b],149===usagePage||8===usagePage)switch(c[0].outputReportID=e.outputReports[p].reportId,usage){case 9:c[0].led_mute=1<<reportPos,t.push(["led-mute",dec2hexString(usage)]);break;case 23:c[0].led_offhook=1<<reportPos,t.push(["led-offhook",dec2hexString(usage)]);break;case 158:c[0].led_ringer=1<<reportPos,t.push(["led-ringer",dec2hexString(usage)]);break;case 24:c[0].led_ring=1<<reportPos,t.push(["led-ring",dec2hexString(usage)]);break;case 32:c[0].led_hold=1<<reportPos,t.push(["led-hold",dec2hexString(usage)]);break;case 33:c[0].led_microphone=1<<reportPos,t.push(["led-microphone",dec2hexString(usage)]);break;case 42:c[0].led_online=1<<reportPos,t.push(["led-online",dec2hexString(usage)])}else 19===usagePage&&158===usage&&(c[0].led_ringer=1<<reportPos,t.push([dec2hexString(usagePage),dec2hexString(usage)]));reportPos+=e.outputReports[p].items[A].reportSize}i.report(t,"Output "+c[0].name,c[0].outputReportID);let n=[];for(p=0;p<e.inputReports.length;p++)for(A=0,reportPos=0;A<e.inputReports[p].items.length;A++)for(b=0;b<e.inputReports[p].items[A].usages.length;b++){if(usagePage=(16711680&e.inputReports[p].items[A].usages[b])>>16,usage=255&e.inputReports[p].items[A].usages[b],19===usagePage||11===usagePage)switch(c[0].inputReportID=e.inputReports[p].reportId,usage){case 32:c[0].telephony_hook=1<<reportPos,n.push(["telephony-hook",dec2hexString(usage)]);break;case 33:c[0].telephony_flash=1<<reportPos,n.push(["telephony-flash",dec2hexString(usage)]);break;case 36:c[0].telephony_redial=1<<reportPos,n.push(["telephony-redial",dec2hexString(usage)]);break;case 47:c[0].telephony_mute=1<<reportPos,n.push(["telephony-mute",dec2hexString(usage)]);break;case 38:c[0].telephony_drop=1<<reportPos,n.push(["telephony-drop",dec2hexString(usage)])}reportPos+=e.inputReports[p].items[A].reportSize}i.report(n,"Input "+c[0].name,c[0].inputReportID)}(),g&&(i.message("New device selected "+n.name),postEvent("HeadsetConnected",n.name)),t=n,i.message("New device available "+t.name),postEvent("HeadsetAvailable",{name:t.name,id:t.id,serial:t.serial,firmware:t.firmware,vid:t.vid,pid:t.pid})},navigator.hid&&(navigator.hid.addEventListener("connect",async({device:e})=>{setTimeout(async function(){for(let t=0;t<e.collections.length;t++)if(5013===e.vendorId&&(65535===e.collections[t].usagePage||65368===e.collections[t].usagePage)||11===e.collections[t].usagePage){i.connection("HID connected: "+getDeviceName(e)),await addNewHeadset(e),await h();break}},1e3)}),navigator.hid.addEventListener("disconnect",async({device:e})=>{for(let t=0;t<e.collections.length;t++)if(5013===e.vendorId&&(65535===e.collections[t].usagePage||65368===e.collections[t].usagePage)||11===e.collections[t].usagePage)for(let t=0;t<c.length;t++)if(c[t].device===e)return i.connection("HID disconnected: "+c[t].name),postEvent("HeadsetRemoved",{name:c[t].name,id:c[t].id,serial:c[t].serial,slave1id:c[t].slave1id.replace("EPOS_",""),slave1serial:c[t].slave1serial,slave2id:c[t].slave2id.replace("EPOS_",""),slave2serial:c[t].slave2serial}),0==t&&g&&postEvent("HeadsetDisconnected",c[0].name),c[t].device.close(),c.splice(t,1),void(0===t&&g&&await h())})),i=new log("LightSkyBlue","LightBlue"),r=new abl(async function(e,t){"loaded"===e?i.init("abl.js was allocated in webhid.js"):"devices"===e?(i&&i.message(t+" ABL devices present"),postEvent("BLsPresent",t),m()):console.log(e+" : "+t)})}